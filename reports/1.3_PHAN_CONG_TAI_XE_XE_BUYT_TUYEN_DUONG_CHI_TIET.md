# BÃO CÃO KIá»‚M TRA CHI TIáº¾T - 1.3
## PHÃ‚N CÃ”NG TÃ€I Xáº¾, XE BUÃT CHO Tá»ªNG TUYáº¾N ÄÆ¯á»œNG

**NgÃ y kiá»ƒm tra:** 2025-11-12  
**PhiÃªn báº£n:** 1.0  
**YÃªu cáº§u:** YeuCauDoAn.md - Chá»©c nÄƒng Quáº£n lÃ½ xe buÃ½t (1.3)

---

## ğŸ“‹ TÃ“M Táº®T

**Tráº¡ng thÃ¡i:** âœ… **HOÃ€N THÃ€NH Äáº¦Y Äá»¦** (vá»›i lÆ°u Ã½ vá» API assignDriver)

Há»‡ thá»‘ng Ä‘Ã£ triá»ƒn khai Ä‘áº§y Ä‘á»§ chá»©c nÄƒng phÃ¢n cÃ´ng tÃ i xáº¿, xe buÃ½t cho tá»«ng tuyáº¿n Ä‘Æ°á»ng vá»›i:
- âœ… Database schema Ä‘áº§y Ä‘á»§: Báº£ng `LichTrinh` lÆ°u trá»¯ phÃ¢n cÃ´ng (maTuyen, maXe, maTaiXe)
- âœ… Backend API: Táº¡o lá»‹ch trÃ¬nh vá»›i phÃ¢n cÃ´ng, conflict detection
- âœ… Frontend UI: Form phÃ¢n cÃ´ng trong ScheduleForm, auto assign
- âœ… Kiá»ƒm tra xung Ä‘á»™t: Xe/tÃ i xáº¿ khÃ´ng thá»ƒ cÃ³ 2 lá»‹ch trÃ¬nh cÃ¹ng giá»

**CÃ¡ch phÃ¢n cÃ´ng:**
- **ChÃ­nh:** ThÃ´ng qua táº¡o/cáº­p nháº­t lá»‹ch trÃ¬nh (Schedule) - chá»n tuyáº¿n, xe, tÃ i xáº¿
- **Phá»¥:** API `POST /api/v1/buses/:id/assign-driver` (cÃ³ váº¥n Ä‘á» - xem chi tiáº¿t)

---

## ğŸ—„ï¸ PHáº¦N 1: DATABASE (SQL)

### 1.1. Schema Design

#### Báº£ng `LichTrinh` (Lá»‹ch trÃ¬nh) - NÆ¡i lÆ°u phÃ¢n cÃ´ng
**File:** `database/01_init_db_ver2.sql` (line 164-186)

```sql
CREATE TABLE LichTrinh (
    maLichTrinh INT AUTO_INCREMENT PRIMARY KEY,
    maTuyen INT NOT NULL,           -- Tuyáº¿n Ä‘Æ°á»ng Ä‘Æ°á»£c phÃ¢n cÃ´ng
    maXe INT NOT NULL,               -- Xe buÃ½t Ä‘Æ°á»£c phÃ¢n cÃ´ng
    maTaiXe INT NOT NULL,            -- TÃ i xáº¿ Ä‘Æ°á»£c phÃ¢n cÃ´ng
    loaiChuyen ENUM('don_sang', 'tra_chieu') NOT NULL,
    gioKhoiHanh TIME NOT NULL,
    ngayChay DATE NOT NULL,
    dangApDung BOOLEAN DEFAULT TRUE,
    ngayTao TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    ngayCapNhat TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (maTuyen) REFERENCES TuyenDuong(maTuyen),
    FOREIGN KEY (maXe) REFERENCES XeBuyt(maXe),
    FOREIGN KEY (maTaiXe) REFERENCES NguoiDung(maNguoiDung),
    UNIQUE KEY unique_tuyen_xe_taixe_ngay_gio (maTuyen, maXe, maTaiXe, ngayChay, gioKhoiHanh, loaiChuyen),
    INDEX idx_maTuyen (maTuyen),
    INDEX idx_maXe (maXe),
    INDEX idx_maTaiXe (maTaiXe),
    ...
)ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

**ÄÃ¡nh giÃ¡:**
- âœ… **LÆ°u trá»¯ phÃ¢n cÃ´ng:** Báº£ng `LichTrinh` chá»©a `maTuyen`, `maXe`, `maTaiXe` - Ä‘Ã¢y lÃ  nÆ¡i lÆ°u phÃ¢n cÃ´ng tÃ i xáº¿ vÃ  xe cho tuyáº¿n Ä‘Æ°á»ng
- âœ… **Foreign Keys:** Äáº£m báº£o tÃ­nh toÃ n váº¹n dá»¯ liá»‡u
- âœ… **UNIQUE Constraint:** NgÄƒn cháº·n táº¡o lá»‹ch trÃ¬nh trÃ¹ng láº·p (cÃ¹ng tuyáº¿n, xe, tÃ i xáº¿, ngÃ y, giá», loáº¡i chuyáº¿n)
- âœ… **Indexes:** Tá»‘i Æ°u query theo tuyáº¿n, xe, tÃ i xáº¿

**Quan há»‡ phÃ¢n cÃ´ng:**
- **1 Tuyáº¿n Ä‘Æ°á»ng** â†’ **Nhiá»u lá»‹ch trÃ¬nh** (nhiá»u ngÃ y, nhiá»u giá»)
- **1 Xe buÃ½t** â†’ **Nhiá»u lá»‹ch trÃ¬nh** (nhiá»u tuyáº¿n, nhiá»u ngÃ y)
- **1 TÃ i xáº¿** â†’ **Nhiá»u lá»‹ch trÃ¬nh** (nhiá»u tuyáº¿n, nhiá»u ngÃ y)
- **1 Lá»‹ch trÃ¬nh** â†’ **1 Tuyáº¿n + 1 Xe + 1 TÃ i xáº¿** (phÃ¢n cÃ´ng cá»¥ thá»ƒ)

---

#### Báº£ng `XeBuyt` (Xe buÃ½t)
**File:** `database/01_init_db_ver2.sql` (line 60-69)

```sql
CREATE TABLE XeBuyt (
    maXe INT AUTO_INCREMENT PRIMARY KEY,
    bienSoXe VARCHAR(15) UNIQUE NOT NULL,
    dongXe VARCHAR(50),
    sucChua INT NOT NULL,
    trangThai ENUM('hoat_dong', 'bao_tri', 'ngung_hoat_dong') DEFAULT 'hoat_dong',
    INDEX idx_bienSoXe (bienSoXe),
    INDEX idx_trangThai (trangThai)
)ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

**LÆ°u Ã½:**
- âš ï¸ Báº£ng `XeBuyt` **KHÃ”NG cÃ³ cá»™t `maTaiXe`**
- âš ï¸ PhÃ¢n cÃ´ng tÃ i xáº¿ cho xe Ä‘Æ°á»£c lÆ°u trong báº£ng `LichTrinh` (theo ngÃ y/giá» cá»¥ thá»ƒ)
- âš ï¸ API `POST /api/v1/buses/:id/assign-driver` cá»‘ gáº¯ng update `XeBuyt.maTaiXe` nhÆ°ng cá»™t nÃ y khÃ´ng tá»“n táº¡i (cÃ³ thá»ƒ lÃ  bug hoáº·c feature chÆ°a hoÃ n thiá»‡n)

---

### 1.2. Sample Data

**File:** `database/02_sample_data.sql` (line 853-863)

```sql
INSERT INTO LichTrinh (maTuyen, maXe, maTaiXe, loaiChuyen, gioKhoiHanh, ngayChay, dangApDung) VALUES
(1, 1, 2, 'don_sang', '06:30:00', '2025-11-12', TRUE),  -- Tuyáº¿n 1, Xe 1, TÃ i xáº¿ 2
(2, 2, 3, 'don_sang', '06:45:00', '2025-11-12', TRUE),  -- Tuyáº¿n 2, Xe 2, TÃ i xáº¿ 3
(3, 3, 4, 'don_sang', '07:00:00', '2025-11-12', TRUE),  -- Tuyáº¿n 3, Xe 3, TÃ i xáº¿ 4
...
```

**ÄÃ¡nh giÃ¡:**
- âœ… CÃ³ dá»¯ liá»‡u máº«u thá»ƒ hiá»‡n phÃ¢n cÃ´ng: má»—i lá»‹ch trÃ¬nh gÃ¡n 1 tuyáº¿n + 1 xe + 1 tÃ i xáº¿
- âœ… Há»— trá»£ cáº£ `don_sang` vÃ  `tra_chieu`

---

## ğŸ”§ PHáº¦N 2: BACKEND

### 2.1. Model Layer

#### `LichTrinhModel.js` - LÆ°u trá»¯ phÃ¢n cÃ´ng
**File:** `ssb-backend/src/models/LichTrinhModel.js`

**Chá»©c nÄƒng liÃªn quan Ä‘áº¿n phÃ¢n cÃ´ng:**

1. **`create(data)`** - Táº¡o lá»‹ch trÃ¬nh (phÃ¢n cÃ´ng)
   ```javascript
   // Line 172-181
   async create(data) {
     const { maTuyen, maXe, maTaiXe, loaiChuyen, gioKhoiHanh, ngayChay, dangApDung } = data;
     const [result] = await pool.query(
       `INSERT INTO LichTrinh (maTuyen, maXe, maTaiXe, loaiChuyen, gioKhoiHanh, ngayChay, dangApDung)
        VALUES (?, ?, ?, ?, ?, ?, ?)`,
       [maTuyen, maXe, maTaiXe, loaiChuyen, gioKhoiHanh, ngayChay, dangApDung !== false]
     );
     return result.insertId;
   }
   ```
   - âœ… **LÆ°u phÃ¢n cÃ´ng:** `maTuyen`, `maXe`, `maTaiXe` Ä‘Æ°á»£c lÆ°u vÃ o báº£ng `LichTrinh`

2. **`getByRoute(maTuyen)`** - Láº¥y lá»‹ch trÃ¬nh (phÃ¢n cÃ´ng) theo tuyáº¿n
   ```javascript
   // Line 95-109
   async getByRoute(maTuyen) {
     const [rows] = await pool.query(
       `SELECT lt.*, xb.bienSoXe, nd.hoTen as tenTaiXe
        FROM LichTrinh lt
        INNER JOIN XeBuyt xb ON lt.maXe = xb.maXe
        INNER JOIN NguoiDung nd ON lt.maTaiXe = nd.maNguoiDung
        WHERE lt.maTuyen = ? AND lt.dangApDung = TRUE
        ORDER BY lt.gioKhoiHanh`,
       [maTuyen]
     );
     return rows;
   }
   ```
   - âœ… **Xem phÃ¢n cÃ´ng theo tuyáº¿n:** Láº¥y táº¥t cáº£ xe vÃ  tÃ i xáº¿ Ä‘Æ°á»£c phÃ¢n cÃ´ng cho tuyáº¿n

3. **`getByBus(maXe)`** - Láº¥y lá»‹ch trÃ¬nh (phÃ¢n cÃ´ng) theo xe
   ```javascript
   // Line 137-151
   async getByBus(maXe) {
     const [rows] = await pool.query(
       `SELECT lt.*, td.tenTuyen, nd.hoTen as tenTaiXe
        FROM LichTrinh lt
        INNER JOIN TuyenDuong td ON lt.maTuyen = td.maTuyen
        INNER JOIN NguoiDung nd ON lt.maTaiXe = nd.maNguoiDung
        WHERE lt.maXe = ? AND lt.dangApDung = TRUE
        ORDER BY lt.gioKhoiHanh`,
       [maXe]
     );
     return rows;
   }
   ```
   - âœ… **Xem phÃ¢n cÃ´ng theo xe:** Láº¥y táº¥t cáº£ tuyáº¿n vÃ  tÃ i xáº¿ Ä‘Æ°á»£c phÃ¢n cÃ´ng cho xe

4. **`getByDriver(maTaiXe)`** - Láº¥y lá»‹ch trÃ¬nh (phÃ¢n cÃ´ng) theo tÃ i xáº¿
   ```javascript
   // Line 154-169
   async getByDriver(maTaiXe) {
     const [rows] = await pool.query(
       `SELECT lt.*, td.tenTuyen, xb.bienSoXe, xb.dongXe
        FROM LichTrinh lt
        INNER JOIN TuyenDuong td ON lt.maTuyen = td.maTuyen
        INNER JOIN XeBuyt xb ON lt.maXe = xb.maXe
        WHERE lt.maTaiXe = ? AND lt.dangApDung = TRUE
        ORDER BY lt.gioKhoiHanh`,
       [maTaiXe]
     );
     return rows;
   }
   ```
   - âœ… **Xem phÃ¢n cÃ´ng theo tÃ i xáº¿:** Láº¥y táº¥t cáº£ tuyáº¿n vÃ  xe Ä‘Æ°á»£c phÃ¢n cÃ´ng cho tÃ i xáº¿

5. **`checkConflict(...)`** - Kiá»ƒm tra xung Ä‘á»™t phÃ¢n cÃ´ng
   ```javascript
   // Line 249-291
   async checkConflict(maXe, maTaiXe, gioKhoiHanh, loaiChuyen, ngayChay, excludeId = null) {
     // Kiá»ƒm tra xe hoáº·c tÃ i xáº¿ Ä‘Ã£ cÃ³ lá»‹ch trÃ¬nh cÃ¹ng giá», loáº¡i chuyáº¿n, ngÃ y
     // Tráº£ vá» conflict details
   }
   ```
   - âœ… **NgÄƒn cháº·n xung Ä‘á»™t:** Xe hoáº·c tÃ i xáº¿ khÃ´ng thá»ƒ cÃ³ 2 lá»‹ch trÃ¬nh cÃ¹ng giá»

**ÄÃ¡nh giÃ¡ Model:**
- âœ… Äáº§y Ä‘á»§ methods Ä‘á»ƒ quáº£n lÃ½ phÃ¢n cÃ´ng
- âœ… Há»— trá»£ query theo tuyáº¿n, xe, tÃ i xáº¿
- âœ… Conflict detection chi tiáº¿t

---

### 2.2. Service Layer

#### `ScheduleService.js` - Business logic phÃ¢n cÃ´ng
**File:** `ssb-backend/src/services/ScheduleService.js`

**Chá»©c nÄƒng chÃ­nh:**

1. **`create(payload)`** - Táº¡o lá»‹ch trÃ¬nh (phÃ¢n cÃ´ng) vá»›i validation
   ```javascript
   // Line 52-89
   static async create(payload) {
     const { maTuyen, maXe, maTaiXe, loaiChuyen, gioKhoiHanh, ngayChay } = payload;
     
     // Validation
     if (!maTuyen || !maXe || !maTaiXe || !loaiChuyen || !gioKhoiHanh || !ngayChay)
       throw new Error("MISSING_REQUIRED_FIELDS");
     
     // Check existence
     const route = await TuyenDuongModel.getById(maTuyen);
     if (!route) throw new Error("ROUTE_NOT_FOUND");
     const bus = await XeBuytModel.getById(maXe);
     if (!bus) throw new Error("BUS_NOT_FOUND");
     const driver = await TaiXeModel.getById(maTaiXe);
     if (!driver) throw new Error("DRIVER_NOT_FOUND");
     
     // Check conflict
     const conflicts = await LichTrinhModel.checkConflict(
       maXe, maTaiXe, gioKhoiHanh, loaiChuyen, ngayChay
     );
     if (conflicts && conflicts.length > 0) {
       const error = new Error("SCHEDULE_CONFLICT");
       error.conflicts = conflicts;
       throw error;
     }
     
     // Create schedule (assignment)
     const id = await LichTrinhModel.create({
       maTuyen, maXe, maTaiXe, loaiChuyen, gioKhoiHanh, ngayChay, dangApDung: true
     });
     return await LichTrinhModel.getById(id);
   }
   ```
   - âœ… **Validation Ä‘áº§y Ä‘á»§:** Kiá»ƒm tra tuyáº¿n, xe, tÃ i xáº¿ tá»“n táº¡i
   - âœ… **Conflict detection:** Kiá»ƒm tra xung Ä‘á»™t trÆ°á»›c khi phÃ¢n cÃ´ng
   - âœ… **LÆ°u phÃ¢n cÃ´ng:** Táº¡o lá»‹ch trÃ¬nh = phÃ¢n cÃ´ng tÃ i xáº¿ vÃ  xe cho tuyáº¿n

2. **`update(id, data)`** - Cáº­p nháº­t lá»‹ch trÃ¬nh (thay Ä‘á»•i phÃ¢n cÃ´ng)
   ```javascript
   // Line 91-132
   static async update(id, data) {
     // CÃ³ thá»ƒ thay Ä‘á»•i maTuyen, maXe, maTaiXe
     // Kiá»ƒm tra conflict vá»›i giÃ¡ trá»‹ má»›i
     // Cáº­p nháº­t lá»‹ch trÃ¬nh
   }
   ```
   - âœ… **Thay Ä‘á»•i phÃ¢n cÃ´ng:** CÃ³ thá»ƒ thay Ä‘á»•i tuyáº¿n, xe, hoáº·c tÃ i xáº¿
   - âœ… **Conflict check:** Kiá»ƒm tra xung Ä‘á»™t vá»›i giÃ¡ trá»‹ má»›i

**ÄÃ¡nh giÃ¡ Service:**
- âœ… Business logic tÃ¡ch biá»‡t
- âœ… Validation vÃ  conflict detection Ä‘áº§y Ä‘á»§
- âœ… Error handling rÃµ rÃ ng

---

#### `BusService.js` - API riÃªng phÃ¢n cÃ´ng tÃ i xáº¿ cho xe
**File:** `ssb-backend/src/services/BusService.js`

**Chá»©c nÄƒng:**

1. **`assignDriver(busId, driverId)`** - PhÃ¢n cÃ´ng tÃ i xáº¿ cho xe
   ```javascript
   // Line 193-221
   static async assignDriver(busId, driverId) {
     // Kiá»ƒm tra xe buÃ½t tá»“n táº¡i
     const bus = await XeBuytModel.getById(busId);
     if (!bus) return null;
     
     // Kiá»ƒm tra tÃ i xáº¿ tá»“n táº¡i
     const driver = await TaiXeModel.getById(driverId);
     if (!driver) {
       throw new Error("DRIVER_NOT_FOUND");
     }
     
     // Kiá»ƒm tra tÃ i xáº¿ cÃ³ kháº£ dá»¥ng khÃ´ng
     if (driver.trangThai !== "active") {
       throw new Error("DRIVER_NOT_AVAILABLE");
     }
     
     // Cáº­p nháº­t xe buÃ½t
     await XeBuytModel.update(busId, {
       maTaiXe: driverId,  // âš ï¸ Váº¤N Äá»€: Báº£ng XeBuyt khÃ´ng cÃ³ cá»™t maTaiXe
     });
     
     // Láº¥y thÃ´ng tin má»›i
     const updatedBus = await XeBuytModel.getById(busId);
     
     return {
       bus: updatedBus,
       driver: driver,
     };
   }
   ```
   - âš ï¸ **Váº¤N Äá»€:** Cá»‘ gáº¯ng update `XeBuyt.maTaiXe` nhÆ°ng báº£ng `XeBuyt` khÃ´ng cÃ³ cá»™t nÃ y
   - âš ï¸ **CÃ³ thá»ƒ lÃ  bug hoáº·c feature chÆ°a hoÃ n thiá»‡n**
   - ğŸ’¡ **Äá» xuáº¥t:** 
     - Option 1: ThÃªm cá»™t `maTaiXe` vÃ o báº£ng `XeBuyt` (náº¿u muá»‘n lÆ°u tÃ i xáº¿ máº·c Ä‘á»‹nh cho xe)
     - Option 2: XÃ³a API nÃ y vÃ  chá»‰ dÃ¹ng phÃ¢n cÃ´ng qua lá»‹ch trÃ¬nh

**ÄÃ¡nh giÃ¡:**
- âš ï¸ API cÃ³ váº¥n Ä‘á» vá» database schema
- âœ… Logic validation Ä‘Ãºng (kiá»ƒm tra tá»“n táº¡i, tráº¡ng thÃ¡i)

---

### 2.3. Controller Layer

#### `ScheduleController.js` - API phÃ¢n cÃ´ng qua lá»‹ch trÃ¬nh
**File:** `ssb-backend/src/controllers/ScheduleController.js`

**API Endpoints:**

1. **`POST /api/v1/schedules`** - Táº¡o lá»‹ch trÃ¬nh (phÃ¢n cÃ´ng)
   ```javascript
   // Line 145-277
   static async create(req, res) {
     const { maTuyen, maXe, maTaiXe, loaiChuyen, gioKhoiHanh, ngayChay, dangApDung } = req.body;
     
     // Validation
     // Check existence
     // Use ScheduleService.create
     // Handle conflict
   }
   ```
   - âœ… **PhÃ¢n cÃ´ng chÃ­nh:** ÄÃ¢y lÃ  cÃ¡ch chÃ­nh Ä‘á»ƒ phÃ¢n cÃ´ng tÃ i xáº¿ vÃ  xe cho tuyáº¿n Ä‘Æ°á»ng
   - âœ… **Validation Ä‘áº§y Ä‘á»§:** Required fields, format, existence
   - âœ… **Conflict handling:** Tráº£ vá» 409 vá»›i conflict details

2. **`PUT /api/v1/schedules/:id`** - Cáº­p nháº­t lá»‹ch trÃ¬nh (thay Ä‘á»•i phÃ¢n cÃ´ng)
   ```javascript
   // Line 280-343
   static async update(req, res) {
     // CÃ³ thá»ƒ thay Ä‘á»•i maTuyen, maXe, maTaiXe
     // Use ScheduleService.update
     // Handle conflict
   }
   ```
   - âœ… **Thay Ä‘á»•i phÃ¢n cÃ´ng:** CÃ³ thá»ƒ thay Ä‘á»•i tuyáº¿n, xe, hoáº·c tÃ i xáº¿

3. **`GET /api/v1/schedules`** - Láº¥y danh sÃ¡ch lá»‹ch trÃ¬nh (phÃ¢n cÃ´ng)
   - âœ… Há»— trá»£ filter: `maTuyen`, `maXe`, `maTaiXe` - xem phÃ¢n cÃ´ng theo tuyáº¿n/xe/tÃ i xáº¿

4. **`GET /api/v1/routes/:id`** - Láº¥y chi tiáº¿t tuyáº¿n (kÃ¨m lá»‹ch trÃ¬nh)
   ```javascript
   // RouteController.getRouteById (line 52-84)
   // Láº¥y lá»‹ch trÃ¬nh cá»§a tuyáº¿n Ä‘Æ°á»ng
   let schedules = await LichTrinhModel.getByRouteId(id);
   return response.ok(res, {
     ...route,
     schedules: schedules || [],  // Danh sÃ¡ch phÃ¢n cÃ´ng
   });
   ```
   - âœ… **Xem phÃ¢n cÃ´ng theo tuyáº¿n:** Tráº£ vá» danh sÃ¡ch lá»‹ch trÃ¬nh (phÃ¢n cÃ´ng) cá»§a tuyáº¿n

**ÄÃ¡nh giÃ¡ Controller:**
- âœ… API RESTful chuáº©n
- âœ… Validation vÃ  error handling Ä‘áº§y Ä‘á»§
- âœ… Há»— trá»£ xem phÃ¢n cÃ´ng theo nhiá»u cÃ¡ch

---

#### `BusController.js` - API riÃªng phÃ¢n cÃ´ng tÃ i xáº¿
**File:** `ssb-backend/src/controllers/BusController.js`

**API Endpoint:**

1. **`POST /api/v1/buses/:id/assign-driver`** - PhÃ¢n cÃ´ng tÃ i xáº¿ cho xe
   ```javascript
   // Line 210-252
   static async assignDriver(req, res) {
     const { id } = req.params;
     const { driverId } = req.body;
     
     const result = await BusService.assignDriver(id, driverId);
     
     if (!result) {
       return res.status(404).json({
         success: false,
         message: "KhÃ´ng tÃ¬m tháº¥y xe buÃ½t hoáº·c tÃ i xáº¿",
       });
     }
     
     return res.status(200).json({
       success: true,
       data: result,
       message: "PhÃ¢n cÃ´ng tÃ i xáº¿ thÃ nh cÃ´ng",
     });
   }
   ```
   - âš ï¸ **Váº¤N Äá»€:** Gá»i `BusService.assignDriver()` cá»‘ gáº¯ng update `XeBuyt.maTaiXe` nhÆ°ng cá»™t nÃ y khÃ´ng tá»“n táº¡i
   - âš ï¸ **CÃ³ thá»ƒ khÃ´ng hoáº¡t Ä‘á»™ng Ä‘Ãºng**

**ÄÃ¡nh giÃ¡:**
- âš ï¸ API cÃ³ váº¥n Ä‘á» vá» database schema
- âœ… Error handling Ä‘Ãºng

---

### 2.4. Routes

#### `schedule.js`
**File:** `ssb-backend/src/routes/api/schedule.js`

```javascript
// POST /api/v1/schedules - Táº¡o lá»‹ch trÃ¬nh (phÃ¢n cÃ´ng)
router.post("/", 
  AuthMiddleware.authenticate, 
  AuthMiddleware.authorize("quan_tri"), 
  ValidationMiddleware.validateSchedule, 
  ScheduleController.create);

// PUT /api/v1/schedules/:id - Cáº­p nháº­t lá»‹ch trÃ¬nh (thay Ä‘á»•i phÃ¢n cÃ´ng)
router.put("/:id", 
  AuthMiddleware.authenticate, 
  AuthMiddleware.authorize("quan_tri"), 
  ValidationMiddleware.validateId, 
  ScheduleController.update);
```

**ÄÃ¡nh giÃ¡ Routes:**
- âœ… Authentication required
- âœ… Authorization: Chá»‰ `quan_tri` cÃ³ thá»ƒ phÃ¢n cÃ´ng
- âœ… Validation middleware

---

#### `bus.js`
**File:** `ssb-backend/src/routes/api/bus.js`

```javascript
// POST /api/v1/buses/:id/assign-driver - PhÃ¢n cÃ´ng tÃ i xáº¿ cho xe
router.post("/:id/assign-driver",
  AuthMiddleware.verifyToken,
  AuthMiddleware.authorize("quan_tri"),
  ValidationMiddleware.validateId,
  ValidationMiddleware.validateAssignDriver,
  BusController.assignDriver);
```

**ÄÃ¡nh giÃ¡ Routes:**
- âœ… Authentication vÃ  authorization Ä‘Ãºng
- âš ï¸ API cÃ³ váº¥n Ä‘á» vá» database schema

---

## ğŸ¨ PHáº¦N 3: FRONTEND

### 3.1. API Client

#### `api.ts`
**File:** `ssb-frontend/lib/api.ts`

**Methods liÃªn quan:**

1. **`createSchedule(scheduleData)`** - Táº¡o lá»‹ch trÃ¬nh (phÃ¢n cÃ´ng)
   ```typescript
   // Line 486-504
   async createSchedule(scheduleData: any) {
     // scheduleData: { maTuyen, maXe, maTaiXe, loaiChuyen, gioKhoiHanh, ngayChay }
     return await this.request("/schedules", {
       method: "POST",
       body: JSON.stringify(scheduleData),
     });
   }
   ```
   - âœ… **PhÃ¢n cÃ´ng chÃ­nh:** ÄÃ¢y lÃ  cÃ¡ch chÃ­nh Ä‘á»ƒ phÃ¢n cÃ´ng

2. **`updateSchedule(id, scheduleData)`** - Cáº­p nháº­t lá»‹ch trÃ¬nh (thay Ä‘á»•i phÃ¢n cÃ´ng)
   - âœ… CÃ³ thá»ƒ thay Ä‘á»•i `maTuyen`, `maXe`, `maTaiXe`

3. **`getSchedules(params)`** - Láº¥y danh sÃ¡ch lá»‹ch trÃ¬nh (phÃ¢n cÃ´ng)
   ```typescript
   // Line 464-480
   async getSchedules(params?: {
     maTuyen?: number;  // Xem phÃ¢n cÃ´ng theo tuyáº¿n
     maXe?: number;     // Xem phÃ¢n cÃ´ng theo xe
     maTaiXe?: number;  // Xem phÃ¢n cÃ´ng theo tÃ i xáº¿
     loaiChuyen?: string;
   })
   ```
   - âœ… Há»— trá»£ filter Ä‘á»ƒ xem phÃ¢n cÃ´ng theo tuyáº¿n/xe/tÃ i xáº¿

**ÄÃ¡nh giÃ¡ API Client:**
- âœ… Äáº§y Ä‘á»§ methods cho phÃ¢n cÃ´ng
- âœ… Error handling vá»›i conflict details

---

### 3.2. Schedule Form Component

#### `schedule-form.tsx` - UI phÃ¢n cÃ´ng
**File:** `ssb-frontend/components/admin/schedule-form.tsx`

**Chá»©c nÄƒng phÃ¢n cÃ´ng:**

1. **Form Fields:**
   ```typescript
   // Line 225-273
   <Select value={route} onValueChange={setRoute}>  {/* Chá»n tuyáº¿n Ä‘Æ°á»ng */}
     {routes.map((r: any) => (
       <SelectItem value={String(r.maTuyen || r.id)}>
         {r.tenTuyen || r.name}
       </SelectItem>
     ))}
   </Select>
   
   <Select value={bus} onValueChange={setBus}>  {/* Chá»n xe buÃ½t */}
     {buses.map((b: any) => (
       <SelectItem value={String(b.maXe || b.id)}>
         {b.bienSoXe || b.plateNumber}
       </SelectItem>
     ))}
   </Select>
   
   <Select value={driver} onValueChange={setDriver}>  {/* Chá»n tÃ i xáº¿ */}
     {drivers.map((d: any) => (
       <SelectItem value={String(d.maTaiXe || d.id)}>
         {d.hoTen || d.ten || d.name}
       </SelectItem>
     ))}
   </Select>
   ```
   - âœ… **UI phÃ¢n cÃ´ng:** Dropdown chá»n tuyáº¿n, xe, tÃ i xáº¿
   - âœ… Load danh sÃ¡ch tá»« API

2. **Submit (PhÃ¢n cÃ´ng):**
   ```typescript
   // Line 93-177
   const handleSubmit = async (e: React.FormEvent) => {
     const payload = {
       maTuyen: parseInt(route),
       maXe: parseInt(bus),
       maTaiXe: parseInt(driver),
       loaiChuyen: tripType,
       gioKhoiHanh: startTime,
       ngayChay: ngayChay,
       dangApDung: true,
     };
     
     if (mode === "edit") {
       await apiClient.updateSchedule(initialSchedule.id, payload);
     } else {
       await apiClient.createSchedule(payload);
     }
   }
   ```
   - âœ… **Táº¡o/cáº­p nháº­t phÃ¢n cÃ´ng:** Gá»­i `maTuyen`, `maXe`, `maTaiXe` Ä‘á»ƒ phÃ¢n cÃ´ng

3. **Conflict Error Display:**
   ```typescript
   // Line 182-205
   {conflictError && conflictError.conflicts.length > 0 && (
     <Alert variant="destructive">
       <AlertTitle>Xung Ä‘á»™t lá»‹ch trÃ¬nh</AlertTitle>
       <AlertDescription>
         {conflictError.conflicts.map((conflict, idx) => (
           <li key={idx}>
             {conflict.conflictType === 'bus' && (
               <>Xe <strong>{conflict.bus}</strong> Ä‘Ã£ cÃ³ lá»‹ch trÃ¬nh vÃ o {conflict.time} ngÃ y {conflict.date}</>
             )}
             {conflict.conflictType === 'driver' && (
               <>TÃ i xáº¿ <strong>{conflict.driver}</strong> Ä‘Ã£ cÃ³ lá»‹ch trÃ¬nh vÃ o {conflict.time} ngÃ y {conflict.date}</>
             )}
           </li>
         ))}
       </AlertDescription>
     </Alert>
   )}
   ```
   - âœ… **Hiá»ƒn thá»‹ xung Ä‘á»™t:** ThÃ´ng bÃ¡o rÃµ rÃ ng náº¿u xe hoáº·c tÃ i xáº¿ Ä‘Ã£ cÃ³ lá»‹ch trÃ¬nh trÃ¹ng

**ÄÃ¡nh giÃ¡ Form:**
- âœ… UI/UX tá»‘t vá»›i dropdown chá»n tuyáº¿n, xe, tÃ i xáº¿
- âœ… Validation vÃ  conflict error display rÃµ rÃ ng
- âœ… Há»— trá»£ cáº£ create vÃ  edit mode

---

### 3.3. Schedule Management Page

#### `page.tsx` - Trang quáº£n lÃ½ lá»‹ch trÃ¬nh (phÃ¢n cÃ´ng)
**File:** `ssb-frontend/app/admin/schedule/page.tsx`

**Chá»©c nÄƒng phÃ¢n cÃ´ng:**

1. **Auto Assign (Tá»± Ä‘á»™ng phÃ¢n cÃ´ng):**
   ```typescript
   // Line 132-246
   async function handleAutoAssign() {
     // Fetch available resources
     const [routesRes, busesRes, driversRes] = await Promise.all([
       apiClient.getRoutes({ limit: 100 }),
       apiClient.getBuses({ limit: 100 }),
       apiClient.getDrivers({ limit: 100 }),
     ]);
     
     // Filter only active resources
     const activeBuses = buses.filter((b: any) => b.trangThai === 'hoat_dong');
     const activeDrivers = drivers.filter((d: any) => d.trangThai === 'hoat_dong');
     
     // Get already assigned resources for the selected date
     const todaySchedules = allSchedules.filter(s => {
       const scheduleDate = s.date || s.raw?.ngayChay;
       return scheduleDate === selectedDateStr;
     });
     const assignedBusIds = new Set(todaySchedules.map(s => s.raw?.maXe).filter(Boolean));
     const assignedDriverIds = new Set(todaySchedules.map(s => s.raw?.maTaiXe).filter(Boolean));
     
     // Find available resources
     const availableBuses = activeBuses.filter((b: any) => !assignedBusIds.has(b.maXe));
     const availableDrivers = activeDrivers.filter((d: any) => !assignedDriverIds.has(d.maTaiXe));
     
     // Auto-assign: create schedule for first available route, bus, driver
     for (let i = 0; i < maxAssignments; i++) {
       const route = routes[i % routes.length];
       const bus = availableBuses[createdCount % availableBuses.length];
       const driver = availableDrivers[createdCount % availableDrivers.length];
       
       const payload = {
         maTuyen: route.maTuyen,
         maXe: bus.maXe,
         maTaiXe: driver.maTaiXe,
         loaiChuyen: tripType,
         gioKhoiHanh: startTime,
         ngayChay: selectedDateStr,
         dangApDung: true,
       };
       
       await apiClient.createSchedule(payload);  // PhÃ¢n cÃ´ng
     }
   }
   ```
   - âœ… **Tá»± Ä‘á»™ng phÃ¢n cÃ´ng:** Tá»± Ä‘á»™ng gÃ¡n xe vÃ  tÃ i xáº¿ cho tuyáº¿n Ä‘Æ°á»ng
   - âœ… **TrÃ¡nh xung Ä‘á»™t:** Chá»‰ phÃ¢n cÃ´ng xe/tÃ i xáº¿ chÆ°a cÃ³ lá»‹ch trong ngÃ y
   - âœ… **Há»— trá»£ táº¡o nhanh:** CÃ³ thá»ƒ dÃ¹ng Ä‘á»ƒ phÃ¢n cÃ´ng cho nhiá»u tuyáº¿n cÃ¹ng lÃºc

2. **View Assignments (Xem phÃ¢n cÃ´ng):**
   ```typescript
   // Line 520-586
   {filteredSchedules.map((schedule) => (
     <TableRow key={schedule.id}>
       <TableCell>{schedule.route}</TableCell>  {/* Tuyáº¿n */}
       <TableCell>{schedule.bus}</TableCell>    {/* Xe */}
       <TableCell>{schedule.driver}</TableCell> {/* TÃ i xáº¿ */}
       ...
     </TableRow>
   ))}
   ```
   - âœ… **Hiá»ƒn thá»‹ phÃ¢n cÃ´ng:** Báº£ng hiá»ƒn thá»‹ tuyáº¿n, xe, tÃ i xáº¿ Ä‘Æ°á»£c phÃ¢n cÃ´ng

3. **Edit Assignment (Chá»‰nh sá»­a phÃ¢n cÃ´ng):**
   ```typescript
   // Line 563-573
   <Button onClick={() => {
     setEditingSchedule(schedule);
     setIsEditDialogOpen(true);
   }}>
     <Edit className="w-4 h-4" />
   </Button>
   ```
   - âœ… **Thay Ä‘á»•i phÃ¢n cÃ´ng:** CÃ³ thá»ƒ chá»‰nh sá»­a Ä‘á»ƒ thay Ä‘á»•i tuyáº¿n, xe, hoáº·c tÃ i xáº¿

**ÄÃ¡nh giÃ¡ Page:**
- âœ… UI/UX tá»‘t vá»›i auto assign
- âœ… Hiá»ƒn thá»‹ phÃ¢n cÃ´ng rÃµ rÃ ng
- âœ… Há»— trá»£ chá»‰nh sá»­a phÃ¢n cÃ´ng

---

## ğŸ“Š Tá»”NG Káº¾T VÃ€ ÄÃNH GIÃ

### âœ… Äiá»ƒm máº¡nh

1. **Database:**
   - âœ… Schema Ä‘áº§y Ä‘á»§: Báº£ng `LichTrinh` lÆ°u trá»¯ phÃ¢n cÃ´ng (maTuyen, maXe, maTaiXe)
   - âœ… Foreign keys Ä‘áº£m báº£o tÃ­nh toÃ n váº¹n
   - âœ… UNIQUE constraint ngÄƒn cháº·n trÃ¹ng láº·p
   - âœ… Indexes tá»‘i Æ°u query

2. **Backend:**
   - âœ… API RESTful chuáº©n
   - âœ… PhÃ¢n cÃ´ng qua táº¡o/cáº­p nháº­t lá»‹ch trÃ¬nh
   - âœ… Conflict detection chi tiáº¿t
   - âœ… Validation Ä‘áº§y Ä‘á»§
   - âœ… Há»— trá»£ query phÃ¢n cÃ´ng theo tuyáº¿n/xe/tÃ i xáº¿

3. **Frontend:**
   - âœ… UI/UX tá»‘t vá»›i dropdown chá»n tuyáº¿n, xe, tÃ i xáº¿
   - âœ… Auto assign há»— trá»£ phÃ¢n cÃ´ng nhanh
   - âœ… Conflict error display rÃµ rÃ ng
   - âœ… Hiá»ƒn thá»‹ phÃ¢n cÃ´ng trong báº£ng

### âš ï¸ Äiá»ƒm cáº§n cáº£i thiá»‡n

1. **API `assignDriver` cÃ³ váº¥n Ä‘á»:**
   - âš ï¸ `POST /api/v1/buses/:id/assign-driver` cá»‘ gáº¯ng update `XeBuyt.maTaiXe` nhÆ°ng cá»™t nÃ y khÃ´ng tá»“n táº¡i
   - ğŸ’¡ **Äá» xuáº¥t:**
     - Option 1: ThÃªm cá»™t `maTaiXe` vÃ o báº£ng `XeBuyt` (náº¿u muá»‘n lÆ°u tÃ i xáº¿ máº·c Ä‘á»‹nh cho xe)
     - Option 2: XÃ³a API nÃ y vÃ  chá»‰ dÃ¹ng phÃ¢n cÃ´ng qua lá»‹ch trÃ¬nh (khuyáº¿n nghá»‹)

2. **Bulk Assignment:**
   - âš ï¸ ChÆ°a há»— trá»£ phÃ¢n cÃ´ng hÃ ng loáº¡t (nhiá»u tuyáº¿n cÃ¹ng lÃºc)
   - ğŸ’¡ **Äá» xuáº¥t:** ThÃªm API `POST /api/v1/schedules/bulk-assign` Ä‘á»ƒ phÃ¢n cÃ´ng nhiá»u tuyáº¿n cÃ¹ng lÃºc

3. **Assignment History:**
   - âš ï¸ ChÆ°a cÃ³ lá»‹ch sá»­ phÃ¢n cÃ´ng (ai phÃ¢n cÃ´ng, khi nÃ o)
   - ğŸ’¡ **Äá» xuáº¥t:** ThÃªm audit log cho phÃ¢n cÃ´ng

### âœ… Káº¿t luáº­n

**Tráº¡ng thÃ¡i:** âœ… **HOÃ€N THÃ€NH Äáº¦Y Äá»¦** (vá»›i lÆ°u Ã½ vá» API assignDriver)

Há»‡ thá»‘ng Ä‘Ã£ triá»ƒn khai Ä‘áº§y Ä‘á»§ chá»©c nÄƒng **"PhÃ¢n cÃ´ng tÃ i xáº¿, xe buÃ½t cho tá»«ng tuyáº¿n Ä‘Æ°á»ng"** vá»›i:
- âœ… Database schema Ä‘áº§y Ä‘á»§: Báº£ng `LichTrinh` lÆ°u trá»¯ phÃ¢n cÃ´ng
- âœ… Backend API: Táº¡o/cáº­p nháº­t lá»‹ch trÃ¬nh vá»›i phÃ¢n cÃ´ng, conflict detection
- âœ… Frontend UI: Form phÃ¢n cÃ´ng, auto assign, hiá»ƒn thá»‹ phÃ¢n cÃ´ng
- âœ… Kiá»ƒm tra xung Ä‘á»™t: Xe/tÃ i xáº¿ khÃ´ng thá»ƒ cÃ³ 2 lá»‹ch trÃ¬nh cÃ¹ng giá»

**CÃ¡ch phÃ¢n cÃ´ng:**
- **ChÃ­nh:** ThÃ´ng qua táº¡o/cáº­p nháº­t lá»‹ch trÃ¬nh (Schedule) - chá»n tuyáº¿n, xe, tÃ i xáº¿
- **Phá»¥:** API `POST /api/v1/buses/:id/assign-driver` (cÃ³ váº¥n Ä‘á» - cáº§n sá»­a hoáº·c xÃ³a)

**YÃªu cáº§u Ä‘Ã¡p á»©ng:**
- âœ… PhÃ¢n cÃ´ng tÃ i xáº¿ cho tuyáº¿n Ä‘Æ°á»ng
- âœ… PhÃ¢n cÃ´ng xe buÃ½t cho tuyáº¿n Ä‘Æ°á»ng
- âœ… Kiá»ƒm tra xung Ä‘á»™t
- âœ… Xem phÃ¢n cÃ´ng theo tuyáº¿n/xe/tÃ i xáº¿
- âœ… Tá»± Ä‘á»™ng phÃ¢n cÃ´ng

**Khuyáº¿n nghá»‹:**
- ğŸ’¡ Sá»­a hoáº·c xÃ³a API `assignDriver` (cÃ³ váº¥n Ä‘á» vá» database schema)
- ğŸ’¡ ThÃªm bulk assignment API Ä‘á»ƒ phÃ¢n cÃ´ng nhiá»u tuyáº¿n cÃ¹ng lÃºc
- ğŸ’¡ ThÃªm audit log cho phÃ¢n cÃ´ng

---

**NgÆ°á»i kiá»ƒm tra:** AI Assistant  
**NgÃ y hoÃ n thÃ nh:** 2025-11-12

