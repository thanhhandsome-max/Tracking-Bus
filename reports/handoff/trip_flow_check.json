{
  "tripStates": {
    "states": ["chua_khoi_hanh", "dang_chay", "hoan_thanh", "huy"],
    "transitions": {
      "start": {
        "from": "chua_khoi_hanh",
        "to": "dang_chay",
        "endpoint": "POST /trips/{id}/start",
        "controller": "TripController.startTrip",
        "file": "ssb-backend/src/controllers/TripController.js:594",
        "validation": "Check trip exists, status is 'chua_khoi_hanh', driver owns trip",
        "socketEvent": "trip_started",
        "socketRooms": ["trip-{tripId}", "bus-{busId}", "role-quan_tri"]
      },
      "end": {
        "from": "dang_chay",
        "to": "hoan_thanh",
        "endpoint": "POST /trips/{id}/end",
        "controller": "TripController.endTrip",
        "file": "ssb-backend/src/controllers/TripController.js",
        "validation": "Check trip exists, status is 'dang_chay', driver owns trip",
        "socketEvent": "trip_completed",
        "socketRooms": ["trip-{tripId}", "bus-{busId}", "role-quan_tri"],
        "cleanup": "TelemetryService.clearTripData"
      },
      "cancel": {
        "from": ["chua_khoi_hanh", "dang_chay"],
        "to": "huy",
        "endpoint": "POST /trips/{id}/cancel",
        "controller": "TripController.cancelTrip",
        "file": "ssb-backend/src/controllers/TripController.js",
        "validation": "Check trip exists, status allows cancellation, user has permission",
        "socketEvent": "trip_cancelled",
        "socketRooms": ["trip-{tripId}", "bus-{busId}", "role-quan_tri"],
        "cleanup": "TelemetryService.clearTripData"
      }
    }
  },
  "proximityChecks": {
    "service": "TelemetryService.checkGeofence",
    "file": "ssb-backend/src/services/telemetryService.js:345",
    "radius": "GEOFENCE_RADIUS = 60 meters",
    "antiSpam": {
      "mechanism": "emittedStops Map<tripId, Set<stopId>>",
      "description": "Only emit approach_stop once per stop per trip",
      "clearOn": "Trip completed or cancelled"
    },
    "trigger": "When GPS update is within 60m of any stop in trip route",
    "socketEvent": "approach_stop",
    "payload": "{ tripId, stopId, stopName, distance, eta }"
  },
  "delayAlerts": {
    "service": "TelemetryService.checkDelay",
    "file": "ssb-backend/src/services/telemetryService.js:444",
    "threshold": "DELAY_THRESHOLD_MIN = 5 minutes",
    "calculation": "Compare current time with scheduled start time",
    "antiSpam": {
      "mechanism": "delayAlertLastSent Map<tripId, timestamp>",
      "interval": "DELAY_ALERT_INTERVAL = 3 minutes (180000ms)",
      "description": "Only send delay alert once every 3 minutes per trip"
    },
    "trigger": "When trip start delay > 5 minutes",
    "socketEvent": "delay_alert",
    "payload": "{ tripId, delayMinutes, scheduledTime, currentTime }",
    "note": "Only checks start delay. ETA-based delay (with EMA speed) not yet implemented (P1 enhancement)"
  },
  "gpsUpdates": {
    "rateLimit": {
      "mechanism": "lastUpdateTime Map<busId, timestamp>",
      "interval": "RATE_LIMIT_MS = 2000ms (2 seconds)",
      "file": "ssb-backend/src/services/telemetryService.js:68"
    },
    "validation": {
      "file": "ssb-backend/src/ws/index.js:147",
      "checks": [
        "Trip exists",
        "Schedule exists",
        "Driver owns trip (user.vaiTro === 'tai_xe' && schedule.maTaiXe === user.userId)"
      ]
    },
    "processing": {
      "service": "TelemetryService.updatePosition",
      "file": "ssb-backend/src/services/telemetryService.js",
      "steps": [
        "Update bus position cache",
        "Check geofence (proximity to stops)",
        "Check delay",
        "Broadcast bus_position_update",
        "Emit approach_stop if within geofence",
        "Emit delay_alert if delayed"
      ]
    },
    "broadcast": {
      "rooms": ["trip-{tripId}", "bus-{busId}", "role-quan_tri"],
      "event": "bus_position_update",
      "payload": "{ busId, tripId, lat, lng, speed, heading, timestamp }"
    }
  },
  "attendance": {
    "checkin": {
      "endpoint": "POST /trips/{id}/students/{studentId}/checkin",
      "controller": "TripController.checkinStudent",
      "file": "ssb-backend/src/controllers/TripController.js",
      "status": "da_don (onboard)",
      "socketEvent": "pickup_status_update",
      "payload": "{ tripId, studentId, status: 'onboard', timestamp }"
    },
    "checkout": {
      "endpoint": "POST /trips/{id}/students/{studentId}/checkout",
      "controller": "TripController.checkoutStudent",
      "file": "ssb-backend/src/controllers/TripController.js",
      "status": "da_tra (dropped)",
      "socketEvent": "pickup_status_update",
      "payload": "{ tripId, studentId, status: 'dropped', timestamp }"
    }
  }
}

