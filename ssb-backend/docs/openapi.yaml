openapi: 3.0.3
info:
  title: Smart School Bus Tracking System API
  version: 1.1.0
  description: |
    API documentation for Smart School Bus Tracking System - Backend v1.1
    Refactored with normalized stops and route_stops junction table.
  contact:
    name: SSB Development Team
servers:
  - url: http://localhost:4000/api/v1
    description: Local development server
  - url: https://api.schoolbus.vn/api/v1
    description: Production server

tags:
  - name: Routes
    description: Route management endpoints
  - name: Stops
    description: Stop management endpoints
  - name: Maps
    description: Google Maps API proxy endpoints
  - name: Trips
    description: Trip lifecycle and tracking endpoints (M5)
  - name: Telemetry
    description: Real-time GPS position updates (M4/M6)

paths:
  /routes:
    get:
      tags:
        - Routes
      summary: Get list of routes
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 10
        - name: search
          in: query
          schema:
            type: string
        - name: trangThai
          in: query
          schema:
            type: boolean
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RouteListResponse"
              example:
                success: true
                data:
                  - maTuyen: 1
                    tenTuyen: "Tuyáº¿n Quáº­n 7 - NhÃ  BÃ¨"
                    diemBatDau: "TrÆ°á»ng Tiá»ƒu há»c ABC"
                    diemKetThuc: "Khu dÃ¢n cÆ° PhÃº XuÃ¢n"
                    thoiGianUocTinh: 45
                    origin_lat: 10.7345
                    origin_lng: 106.7212
                    dest_lat: 10.6972
                    dest_lng: 106.7041
                    polyline: null
                    trangThai: true
                pagination:
                  page: 1
                  limit: 10
                  total: 5
                  totalPages: 1
                message: "Láº¥y danh sÃ¡ch tuyáº¿n Ä‘Æ°á»ng thÃ nh cÃ´ng"
        "500":
          $ref: "#/components/responses/InternalError"

    post:
      tags:
        - Routes
      summary: Create a new route
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateRoutePayload"
            example:
              tenTuyen: "Tuyáº¿n Quáº­n 7 - Quáº­n 8"
              diemBatDau: "TrÆ°á»ng Tiá»ƒu há»c ABC"
              diemKetThuc: "Khu dÃ¢n cÆ° Quáº­n 8"
              thoiGianUocTinh: 50
      responses:
        "201":
          description: Route created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RouteDetailResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "409":
          $ref: "#/components/responses/Conflict"
        "500":
          $ref: "#/components/responses/InternalError"

  /routes/{id}:
    get:
      tags:
        - Routes
      summary: Get route by ID
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RouteDetailResponse"
              example:
                success: true
                data:
                  maTuyen: 1
                  tenTuyen: "Tuyáº¿n Quáº­n 7 - NhÃ  BÃ¨"
                  diemBatDau: "TrÆ°á»ng Tiá»ƒu há»c ABC"
                  diemKetThuc: "Khu dÃ¢n cÆ° PhÃº XuÃ¢n"
                  thoiGianUocTinh: 45
                  origin_lat: 10.7345
                  origin_lng: 106.7212
                  dest_lat: 10.6972
                  dest_lng: 106.7041
                  polyline: null
                  trangThai: true
                  stops:
                    - maDiem: 1
                      tenDiem: "NgÃ£ tÆ° Nguyá»…n VÄƒn Linh"
                      viDo: 10.7345
                      kinhDo: 106.7212
                      address: null
                      scheduled_time: null
                      sequence: 1
                      dwell_seconds: 30
                    - maDiem: 2
                      tenDiem: "Chung cÆ° Sunrise City"
                      viDo: 10.7408
                      kinhDo: 106.7075
                      address: null
                      scheduled_time: null
                      sequence: 2
                      dwell_seconds: 30
                  schedules: []
                message: "Láº¥y thÃ´ng tin tuyáº¿n Ä‘Æ°á»ng thÃ nh cÃ´ng"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

    put:
      tags:
        - Routes
      summary: Update route
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateRoutePayload"
      responses:
        "200":
          description: Route updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RouteDetailResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"
        "409":
          $ref: "#/components/responses/Conflict"
        "500":
          $ref: "#/components/responses/InternalError"

    delete:
      tags:
        - Routes
      summary: Delete route
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: Route deleted successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SuccessResponse"
        "404":
          $ref: "#/components/responses/NotFound"
        "409":
          $ref: "#/components/responses/Conflict"
        "500":
          $ref: "#/components/responses/InternalError"

  /routes/{id}/stops:
    get:
      tags:
        - Routes
      summary: Get stops for a route
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/RouteStopDetail"
                  message:
                    type: string
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

    post:
      tags:
        - Routes
      summary: Add stop to route
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                stop_id:
                  type: integer
                  description: Existing stop ID (optional if creating new stop)
                sequence:
                  type: integer
                  description: Sequence order (optional, auto-increment if not provided)
                dwell_seconds:
                  type: integer
                  default: 30
                tenDiem:
                  type: string
                  description: Required if stop_id not provided
                viDo:
                  type: number
                  description: Required if stop_id not provided
                kinhDo:
                  type: number
                  description: Required if stop_id not provided
                address:
                  type: string
                scheduled_time:
                  type: string
                  format: time
              required:
                - stop_id
            example:
              stop_id: 1
              sequence: 3
              dwell_seconds: 30
      responses:
        "201":
          description: Stop added successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/RouteStopDetail"
                  message:
                    type: string
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"
        "409":
          $ref: "#/components/responses/Conflict"
        "500":
          $ref: "#/components/responses/InternalError"

  /routes/{id}/stops/reorder:
    patch:
      tags:
        - Routes
      summary: Reorder stops in route
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ReorderStopsPayload"
            example:
              items:
                - stop_id: 1
                  sequence: 2
                - stop_id: 2
                  sequence: 1
      responses:
        "200":
          description: Stops reordered successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/RouteStopDetail"
                  message:
                    type: string
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  /routes/{id}/stops/{stopId}:
    delete:
      tags:
        - Routes
      summary: Remove stop from route
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
        - name: stopId
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: Stop removed successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SuccessResponse"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  /routes/{id}/rebuild-polyline:
    post:
      tags:
        - Routes
      summary: Rebuild polyline for route
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: Polyline rebuilt successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      polyline:
                        type: string
                      updated:
                        type: boolean
                      cached:
                        type: boolean
                  message:
                    type: string
              example:
                success: true
                data:
                  polyline: "encoded_polyline_string"
                  updated: true
                  cached: false
                message: "Rebuild polyline thÃ nh cÃ´ng"
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"
        "503":
          $ref: "#/components/responses/ServiceUnavailable"
        "500":
          $ref: "#/components/responses/InternalError"

  /stops:
    get:
      tags:
        - Stops
      summary: Get list of stops
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 10
        - name: search
          in: query
          schema:
            type: string
        - name: minLat
          in: query
          schema:
            type: number
        - name: maxLat
          in: query
          schema:
            type: number
        - name: minLng
          in: query
          schema:
            type: number
        - name: maxLng
          in: query
          schema:
            type: number
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/Stop"
                  pagination:
                    $ref: "#/components/schemas/Pagination"
                  message:
                    type: string
        "500":
          $ref: "#/components/responses/InternalError"

    post:
      tags:
        - Stops
      summary: Create a new stop
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateStopPayload"
      responses:
        "201":
          description: Stop created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: "#/components/schemas/Stop"
                  message:
                    type: string
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalError"

  /stops/{id}:
    get:
      tags:
        - Stops
      summary: Get stop by ID
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: "#/components/schemas/Stop"
                  message:
                    type: string
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

    put:
      tags:
        - Stops
      summary: Update stop
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateStopPayload"
      responses:
        "200":
          description: Stop updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: "#/components/schemas/Stop"
                  message:
                    type: string
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

    delete:
      tags:
        - Stops
      summary: Delete stop
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: Stop deleted successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SuccessResponse"
        "404":
          $ref: "#/components/responses/NotFound"
        "409":
          $ref: "#/components/responses/Conflict"
        "500":
          $ref: "#/components/responses/InternalError"

  /maps/directions:
    post:
      tags:
        - Maps
      summary: Get directions
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/DirectionsRequest"
            example:
              origin: "10.7345,106.7212"
              destination: "10.6972,106.7041"
              waypoints:
                - location: "10.7408,106.7075"
              mode: "driving"
              language: "vi"
              units: "metric"
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: "#/components/schemas/DirectionsResponse"
                  message:
                    type: string
              example:
                success: true
                data:
                  polyline: "encoded_polyline"
                  legs:
                    - distance: 5234
                      duration: 900
                      start_address: "NgÃ£ tÆ° Nguyá»…n VÄƒn Linh"
                      end_address: "Khu dÃ¢n cÆ° PhÃº XuÃ¢n"
                  distance: 5234
                  duration: 900
                  cached: false
                message: "Láº¥y directions thÃ nh cÃ´ng"
        "400":
          $ref: "#/components/responses/BadRequest"
        "429":
          $ref: "#/components/responses/RateLimitExceeded"
        "503":
          $ref: "#/components/responses/ServiceUnavailable"
        "500":
          $ref: "#/components/responses/InternalError"

  /maps/distance-matrix:
    post:
      tags:
        - Maps
      summary: Get distance matrix
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/DistanceMatrixRequest"
            example:
              origins:
                - "10.7345,106.7212"
              destinations:
                - "10.6972,106.7041"
              mode: "driving"
              language: "vi"
              units: "metric"
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: "#/components/schemas/DistanceMatrixResponse"
                  message:
                    type: string
              example:
                success: true
                data:
                  rows:
                    - - distance: 5234
                        duration: 900
                        status: "OK"
                  origin_addresses:
                    - "NgÃ£ tÆ° Nguyá»…n VÄƒn Linh, Quáº­n 7"
                  destination_addresses:
                    - "Khu dÃ¢n cÆ° PhÃº XuÃ¢n, NhÃ  BÃ¨"
                  cached: true
                message: "Láº¥y distance matrix thÃ nh cÃ´ng"
        "400":
          $ref: "#/components/responses/BadRequest"
        "429":
          $ref: "#/components/responses/RateLimitExceeded"
        "503":
          $ref: "#/components/responses/ServiceUnavailable"
        "500":
          $ref: "#/components/responses/InternalError"

  /maps/geocode:
    post:
      tags:
        - Maps
      summary: Geocode address to coordinates
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/GeocodeRequest"
            example:
              address: "NgÃ£ tÆ° Nguyá»…n VÄƒn Linh, Quáº­n 7, TP.HCM"
              language: "vi"
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: "#/components/schemas/GeocodeResponse"
                  message:
                    type: string
        "400":
          $ref: "#/components/responses/BadRequest"
        "429":
          $ref: "#/components/responses/RateLimitExceeded"
        "503":
          $ref: "#/components/responses/ServiceUnavailable"
        "500":
          $ref: "#/components/responses/InternalError"

  /maps/reverse-geocode:
    post:
      tags:
        - Maps
      summary: Reverse geocode coordinates to address
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - latlng
              properties:
                latlng:
                  type: string
                  example: "10.7345,106.7212"
                language:
                  type: string
                  default: "vi"
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: "#/components/schemas/GeocodeResponse"
                  message:
                    type: string
        "400":
          $ref: "#/components/responses/BadRequest"
        "429":
          $ref: "#/components/responses/RateLimitExceeded"
        "503":
          $ref: "#/components/responses/ServiceUnavailable"
        "500":
          $ref: "#/components/responses/InternalError"

  /maps/roads/snap:
    post:
      tags:
        - Maps
      summary: Snap path to roads
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RoadsSnapRequest"
            example:
              path:
                - lat: 10.7345
                  lng: 106.7212
                - lat: 10.7408
                  lng: 106.7075
              interpolate: true
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: "#/components/schemas/RoadsSnapResponse"
                  message:
                    type: string
        "400":
          $ref: "#/components/responses/BadRequest"
        "429":
          $ref: "#/components/responses/RateLimitExceeded"
        "503":
          $ref: "#/components/responses/ServiceUnavailable"
        "500":
          $ref: "#/components/responses/InternalError"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸšŒ TRIPS API (M5) - Trip Lifecycle Management
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  /trips:
    get:
      tags:
        - Trips
      summary: Get list of trips
      description: |
        Get paginated list of trips with filtering and sorting.
        Supports search, status filter, date filter.
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 10
        - name: q
          in: query
          description: Search query (route name, bus plate, driver name)
          schema:
            type: string
        - name: ngayChay
          in: query
          description: Filter by date (YYYY-MM-DD)
          schema:
            type: string
            format: date
        - name: trangThai
          in: query
          description: Filter by status
          schema:
            type: string
            enum: [chua_khoi_hanh, dang_chay, hoan_thanh, huy]
        - name: sortBy
          in: query
          schema:
            type: string
            default: ngayChay
        - name: sortOrder
          in: query
          schema:
            type: string
            enum: [asc, desc]
            default: desc
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/Trip"
                  meta:
                    type: object
                    properties:
                      page:
                        type: integer
                      pageSize:
                        type: integer
                      total:
                        type: integer
        "500":
          $ref: "#/components/responses/InternalError"

    post:
      tags:
        - Trips
      summary: Create new trip
      description: Create a new trip from schedule
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateTripRequest"
      responses:
        "201":
          description: Trip created successfully
        "409":
          description: Trip already exists for this schedule and date
        "500":
          $ref: "#/components/responses/InternalError"

  /trips/{id}:
    get:
      tags:
        - Trips
      summary: Get trip by ID
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: "#/components/schemas/TripDetail"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  /trips/{id}/start:
    post:
      tags:
        - Trips
      summary: Start trip (M5)
      description: |
        Start a trip. Changes status from 'chua_khoi_hanh' to 'dang_chay'.
        Emits WebSocket event 'trip_started' to all subscribers.
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: Trip started successfully
        "400":
          description: Invalid trip status
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  /trips/{id}/end:
    post:
      tags:
        - Trips
      summary: End trip (M5)
      description: |
        End a trip. Changes status to 'hoan_thanh'.
        Emits WebSocket event 'trip_completed'.
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: Trip ended successfully
        "400":
          description: Invalid trip status
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  /trips/{id}/students/{studentId}/checkin:
    post:
      tags:
        - Trips
      summary: Check-in student (M6)
      description: Mark student as onboard. Emits 'pickup_status_update' event.
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
        - name: studentId
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: Student checked in successfully
        "400":
          description: Trip not running
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  /trips/{id}/students/{studentId}/checkout:
    post:
      tags:
        - Trips
      summary: Check-out student (M6)
      description: Mark student as dropped. Emits 'pickup_status_update' event.
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
        - name: studentId
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: Student checked out successfully
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  /trips/stats:
    get:
      tags:
        - Trips
      summary: Get trip statistics (M7)
      description: Get aggregated trip statistics for dashboard
      parameters:
        - name: from
          in: query
          required: true
          schema:
            type: string
            format: date
        - name: to
          in: query
          required: true
          schema:
            type: string
            format: date
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: "#/components/schemas/TripStats"
        "400":
          description: Missing required parameters
        "500":
          $ref: "#/components/responses/InternalError"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ“¡ TELEMETRY API (M4/M6) - Real-time GPS Position Updates
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  /trips/{id}/telemetry:
    post:
      tags:
        - Telemetry
      summary: Update bus position (REST fallback)
      description: |
        REST fallback for GPS updates (prefer WebSocket 'gps:update' event).
        Rate limited to 1 update per 2 seconds.
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TelemetryRequest"
      responses:
        "200":
          description: Position updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  data:
                    type: object
                    properties:
                      position:
                        $ref: "#/components/schemas/BusPosition"
                      events:
                        type: array
                        items:
                          type: string
        "400":
          description: Validation error or rate limit exceeded
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  /buses/{id}/position:
    get:
      tags:
        - Telemetry
      summary: Get current bus position
      description: Get last known position from cache
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: "#/components/schemas/BusPosition"
        "404":
          description: Bus position not found
        "500":
          $ref: "#/components/responses/InternalError"

components:
  schemas:
    Route:
      type: object
      properties:
        maTuyen:
          type: integer
        tenTuyen:
          type: string
        diemBatDau:
          type: string
        diemKetThuc:
          type: string
        thoiGianUocTinh:
          type: integer
        origin_lat:
          type: number
          format: float
        origin_lng:
          type: number
          format: float
        dest_lat:
          type: number
          format: float
        dest_lng:
          type: number
          format: float
        polyline:
          type: string
          nullable: true
        trangThai:
          type: boolean
        ngayTao:
          type: string
          format: date-time
        ngayCapNhat:
          type: string
          format: date-time

    Stop:
      type: object
      properties:
        maDiem:
          type: integer
        tenDiem:
          type: string
        viDo:
          type: number
          format: float
        kinhDo:
          type: number
          format: float
        address:
          type: string
          nullable: true
        scheduled_time:
          type: string
          format: time
          nullable: true
        ngayTao:
          type: string
          format: date-time
        ngayCapNhat:
          type: string
          format: date-time

    RouteStop:
      type: object
      properties:
        route_id:
          type: integer
        stop_id:
          type: integer
        sequence:
          type: integer
        dwell_seconds:
          type: integer

    RouteStopDetail:
      allOf:
        - $ref: "#/components/schemas/Stop"
        - type: object
          properties:
            sequence:
              type: integer
            dwell_seconds:
              type: integer

    RouteDetail:
      allOf:
        - $ref: "#/components/schemas/Route"
        - type: object
          properties:
            stops:
              type: array
              items:
                $ref: "#/components/schemas/RouteStopDetail"
            schedules:
              type: array
              items:
                type: object

    CreateRoutePayload:
      type: object
      required:
        - tenTuyen
        - diemBatDau
        - diemKetThuc
      properties:
        tenTuyen:
          type: string
        diemBatDau:
          type: string
        diemKetThuc:
          type: string
        thoiGianUocTinh:
          type: integer
        origin_lat:
          type: number
          format: float
        origin_lng:
          type: number
          format: float
        dest_lat:
          type: number
          format: float
        dest_lng:
          type: number
          format: float
        polyline:
          type: string
        trangThai:
          type: boolean
          default: true

    UpdateRoutePayload:
      type: object
      properties:
        tenTuyen:
          type: string
        diemBatDau:
          type: string
        diemKetThuc:
          type: string
        thoiGianUocTinh:
          type: integer
        origin_lat:
          type: number
          format: float
        origin_lng:
          type: number
          format: float
        dest_lat:
          type: number
          format: float
        dest_lng:
          type: number
          format: float
        polyline:
          type: string
        trangThai:
          type: boolean

    CreateStopPayload:
      type: object
      required:
        - tenDiem
        - viDo
        - kinhDo
      properties:
        tenDiem:
          type: string
        viDo:
          type: number
          format: float
        kinhDo:
          type: number
          format: float
        address:
          type: string
        scheduled_time:
          type: string
          format: time

    UpdateStopPayload:
      type: object
      properties:
        tenDiem:
          type: string
        viDo:
          type: number
          format: float
        kinhDo:
          type: number
          format: float
        address:
          type: string
        scheduled_time:
          type: string
          format: time

    ReorderStopsPayload:
      type: object
      required:
        - items
      properties:
        items:
          type: array
          items:
            type: object
            required:
              - stop_id
              - sequence
            properties:
              stop_id:
                type: integer
              sequence:
                type: integer

    DirectionsRequest:
      type: object
      required:
        - origin
        - destination
      properties:
        origin:
          type: string
        destination:
          type: string
        waypoints:
          type: array
          items:
            type: object
            properties:
              location:
                type: string
        mode:
          type: string
          enum: [driving, walking, bicycling, transit]
          default: driving
        alternatives:
          type: boolean
          default: false
        avoid:
          type: array
          items:
            type: string
          enum: [tolls, highways, ferries, indoor]
        language:
          type: string
          default: vi
        units:
          type: string
          enum: [metric, imperial]
          default: metric

    DirectionsResponse:
      type: object
      properties:
        polyline:
          type: string
        legs:
          type: array
          items:
            type: object
            properties:
              distance:
                type: integer
              duration:
                type: integer
              start_address:
                type: string
              end_address:
                type: string
              start_location:
                type: object
                properties:
                  lat:
                    type: number
                  lng:
                    type: number
              end_location:
                type: object
                properties:
                  lat:
                    type: number
                  lng:
                    type: number
        distance:
          type: integer
        duration:
          type: integer
        cached:
          type: boolean

    DistanceMatrixRequest:
      type: object
      required:
        - origins
        - destinations
      properties:
        origins:
          type: array
          items:
            type: string
        destinations:
          type: array
          items:
            type: string
        mode:
          type: string
          enum: [driving, walking, bicycling, transit]
          default: driving
        avoid:
          type: array
          items:
            type: string
        language:
          type: string
          default: vi
        units:
          type: string
          enum: [metric, imperial]
          default: metric
        departure_time:
          type: integer
        traffic_model:
          type: string
          enum: [best_guess, pessimistic, optimistic]

    DistanceMatrixResponse:
      type: object
      properties:
        rows:
          type: array
          items:
            type: array
            items:
              type: object
              properties:
                distance:
                  type: integer
                  nullable: true
                duration:
                  type: integer
                  nullable: true
                status:
                  type: string
        origin_addresses:
          type: array
          items:
            type: string
        destination_addresses:
          type: array
          items:
            type: string
        cached:
          type: boolean

    GeocodeRequest:
      type: object
      properties:
        address:
          type: string
        latlng:
          type: string
        language:
          type: string
          default: vi

    GeocodeResponse:
      type: object
      properties:
        results:
          type: array
          items:
            type: object
            properties:
              formatted_address:
                type: string
              geometry:
                type: object
                properties:
                  location:
                    type: object
                    properties:
                      lat:
                        type: number
                      lng:
                        type: number
                  location_type:
                    type: string
              place_id:
                type: string
              types:
                type: array
                items:
                  type: string
        cached:
          type: boolean

    RoadsSnapRequest:
      type: object
      required:
        - path
      properties:
        path:
          type: array
          items:
            type: object
            required:
              - lat
              - lng
            properties:
              lat:
                type: number
              lng:
                type: number
        interpolate:
          type: boolean
          default: true

    RoadsSnapResponse:
      type: object
      properties:
        snappedPolyline:
          type: array
          items:
            type: object
            properties:
              location:
                type: object
                properties:
                  lat:
                    type: number
                  lng:
                    type: number
              originalIndex:
                type: integer
              placeId:
                type: string
        cached:
          type: boolean

    Pagination:
      type: object
      properties:
        page:
          type: integer
        limit:
          type: integer
        total:
          type: integer
        totalPages:
          type: integer

    RouteListResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: array
          items:
            $ref: "#/components/schemas/Route"
        pagination:
          $ref: "#/components/schemas/Pagination"
        message:
          type: string

    RouteDetailResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          $ref: "#/components/schemas/RouteDetail"
        message:
          type: string

    SuccessResponse:
      type: object
      properties:
        success:
          type: boolean
        message:
          type: string

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
        error:
          type: object
          properties:
            code:
              type: string
            message:
              type: string

  responses:
    BadRequest:
      description: Bad request
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            success: false
            error:
              code: "MISSING_REQUIRED_FIELDS"
              message: "Missing required fields"

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            success: false
            error:
              code: "ROUTE_NOT_FOUND"
              message: "KhÃ´ng tÃ¬m tháº¥y tuyáº¿n Ä‘Æ°á»ng"

    Conflict:
      description: Resource conflict
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            success: false
            error:
              code: "DUPLICATE_ROUTE_NAME"
              message: "TÃªn tuyáº¿n Ä‘Æ°á»ng Ä‘Ã£ tá»“n táº¡i"

    RateLimitExceeded:
      description: Rate limit exceeded
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            success: false
            error:
              code: "RATE_LIMIT_EXCEEDED"
              message: "Too many requests, please try again later"

    ServiceUnavailable:
      description: Service unavailable
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            success: false
            error:
              code: "MAPS_API_NOT_CONFIGURED"
              message: "Maps API key chÆ°a Ä‘Æ°á»£c cáº¥u hÃ¬nh"

    InternalError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            success: false
            error:
              code: "INTERNAL_ERROR"
              message: "Lá»—i server"

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ğŸšŒ TRIP SCHEMAS (M5)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    Trip:
      type: object
      properties:
        maChuyen:
          type: integer
          description: Trip ID
        maLichTrinh:
          type: integer
          description: Schedule ID
        ngayChay:
          type: string
          format: date
          description: Trip date (YYYY-MM-DD)
        trangThai:
          type: string
          enum: [chua_khoi_hanh, dang_chay, hoan_thanh, huy]
          description: Trip status
        gioBatDauThucTe:
          type: string
          format: date-time
          nullable: true
          description: Actual start time
        gioKetThucThucTe:
          type: string
          format: date-time
          nullable: true
          description: Actual end time
        ghiChu:
          type: string
          nullable: true
          description: Notes
        tenTuyen:
          type: string
          description: Route name (joined)
        bienSoXe:
          type: string
          description: Bus plate (joined)
        tenTaiXe:
          type: string
          description: Driver name (joined)

    TripDetail:
      allOf:
        - $ref: "#/components/schemas/Trip"
        - type: object
          properties:
            schedule:
              type: object
              description: Schedule details
            busInfo:
              type: object
              description: Bus details
            driverInfo:
              type: object
              description: Driver details
            routeInfo:
              type: object
              description: Route details with stops
            students:
              type: array
              items:
                type: object
              description: Students in this trip

    CreateTripRequest:
      type: object
      required:
        - maLichTrinh
        - ngayChay
      properties:
        maLichTrinh:
          type: integer
          description: Schedule ID
        ngayChay:
          type: string
          format: date
          description: Trip date (YYYY-MM-DD)
        trangThai:
          type: string
          enum: [chua_khoi_hanh]
          default: chua_khoi_hanh
        ghiChu:
          type: string
          nullable: true

    TripStats:
      type: object
      properties:
        totalTrips:
          type: number
          description: Total number of trips
        completedTrips:
          type: number
          description: Number of completed trips
        cancelledTrips:
          type: number
          description: Number of cancelled trips
        delayedTrips:
          type: number
          description: Number of delayed trips
        averageDuration:
          type: number
          format: float
          description: Average trip duration in minutes
        onTimePercentage:
          type: number
          format: float
          description: Percentage of on-time trips (0-100)

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ğŸ“¡ TELEMETRY SCHEMAS (M4/M6)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    TelemetryRequest:
      type: object
      required:
        - lat
        - lng
      properties:
        lat:
          type: number
          format: float
          minimum: -90
          maximum: 90
          description: Latitude
          example: 10.762622
        lng:
          type: number
          format: float
          minimum: -180
          maximum: 180
          description: Longitude
          example: 106.660172
        speed:
          type: number
          format: float
          minimum: 0
          description: Speed in km/h
          example: 35
        heading:
          type: number
          format: float
          minimum: 0
          maximum: 360
          description: Heading in degrees (0-360)
          example: 92

    BusPosition:
      type: object
      properties:
        lat:
          type: number
          format: float
          description: Latitude
        lng:
          type: number
          format: float
          description: Longitude
        speed:
          type: number
          format: float
          description: Speed in km/h
        heading:
          type: number
          format: float
          description: Heading in degrees
        timestamp:
          type: string
          format: date-time
          description: Position timestamp
        tripId:
          type: integer
          description: Associated trip ID
        busId:
          type: integer
          description: Bus ID
# TODO: Add security schemes when authentication is implemented
# security:
#   - bearerAuth: []
