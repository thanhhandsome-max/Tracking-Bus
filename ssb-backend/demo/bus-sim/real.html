<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SSB - Real GPS Test (Ch·∫ø ƒë·ªô Th·ª±c t·∫ø)</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      .container {
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        max-width: 500px;
        width: 100%;
        padding: 30px;
      }

      h1 {
        color: #667eea;
        font-size: 24px;
        margin-bottom: 10px;
        text-align: center;
      }

      .subtitle {
        color: #666;
        font-size: 14px;
        text-align: center;
        margin-bottom: 30px;
      }

      .status {
        background: #f7fafc;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
      }

      .status-item {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid #e2e8f0;
      }

      .status-item:last-child {
        border-bottom: none;
      }

      .status-label {
        color: #718096;
        font-size: 14px;
      }

      .status-value {
        color: #2d3748;
        font-weight: 600;
        font-size: 14px;
      }

      .status-value.connected {
        color: #48bb78;
      }

      .status-value.disconnected {
        color: #f56565;
      }

      .btn {
        width: 100%;
        padding: 15px;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        margin-bottom: 10px;
      }

      .btn-primary {
        background: #667eea;
        color: white;
      }

      .btn-primary:hover {
        background: #5568d3;
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
      }

      .btn-primary:disabled {
        background: #cbd5e0;
        cursor: not-allowed;
        transform: none;
      }

      .btn-danger {
        background: #f56565;
        color: white;
      }

      .btn-danger:hover {
        background: #e53e3e;
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(245, 101, 101, 0.3);
      }

      .config {
        background: #f7fafc;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-group label {
        display: block;
        color: #4a5568;
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 5px;
      }

      .form-group input {
        width: 100%;
        padding: 10px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.3s;
      }

      .form-group input:focus {
        outline: none;
        border-color: #667eea;
      }

      .log {
        background: #1a202c;
        color: #e2e8f0;
        border-radius: 10px;
        padding: 15px;
        max-height: 300px;
        overflow-y: auto;
        font-family: "Courier New", monospace;
        font-size: 12px;
        line-height: 1.5;
      }

      .log-item {
        margin-bottom: 8px;
        padding: 5px;
        border-left: 3px solid #4a5568;
        padding-left: 10px;
      }

      .log-item.info {
        border-left-color: #4299e1;
      }

      .log-item.success {
        border-left-color: #48bb78;
      }

      .log-item.warning {
        border-left-color: #ed8936;
      }

      .log-item.error {
        border-left-color: #f56565;
      }

      .timestamp {
        color: #718096;
        margin-right: 10px;
      }

      .coordinates {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 20px;
      }

      .coord-box {
        background: #f7fafc;
        border-radius: 10px;
        padding: 15px;
        text-align: center;
      }

      .coord-label {
        color: #718096;
        font-size: 12px;
        margin-bottom: 5px;
      }

      .coord-value {
        color: #2d3748;
        font-size: 20px;
        font-weight: 700;
      }

      .alert {
        background: #fff5f5;
        border: 2px solid #feb2b2;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
        color: #742a2a;
      }

      .alert-title {
        font-weight: 600;
        margin-bottom: 5px;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .sending {
        animation: pulse 1s infinite;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üöå Real GPS Test</h1>
      <p class="subtitle">Ch·∫ø ƒë·ªô th·ª±c t·∫ø - L·∫•y GPS t·ª´ thi·∫øt b·ªã</p>

      <div class="config">
        <div class="form-group">
          <label for="tripId">Trip ID</label>
          <input
            type="number"
            id="tripId"
            value="16"
            placeholder="Nh·∫≠p Trip ID"
          />
        </div>
        <div class="form-group">
          <label for="token">Access Token</label>
          <input
            type="text"
            id="token"
            placeholder="D√°n JWT token t√†i x·∫ø v√†o ƒë√¢y"
          />
        </div>
        <div class="form-group">
          <label for="wsUrl">WebSocket URL</label>
          <input
            type="text"
            id="wsUrl"
            value="http://localhost:4000"
            placeholder="http://localhost:4000"
          />
        </div>
      </div>

      <div class="status">
        <div class="status-item">
          <span class="status-label">WebSocket</span>
          <span class="status-value disconnected" id="wsStatus"
            >Disconnected</span
          >
        </div>
        <div class="status-item">
          <span class="status-label">GPS</span>
          <span class="status-value disconnected" id="gpsStatus">Inactive</span>
        </div>
        <div class="status-item">
          <span class="status-label">Updates Sent</span>
          <span class="status-value" id="updateCount">0</span>
        </div>
        <div class="status-item">
          <span class="status-label">Accuracy</span>
          <span class="status-value" id="accuracy">-</span>
        </div>
      </div>

      <div class="coordinates">
        <div class="coord-box">
          <div class="coord-label">Latitude</div>
          <div class="coord-value" id="lat">-</div>
        </div>
        <div class="coord-box">
          <div class="coord-label">Longitude</div>
          <div class="coord-value" id="lng">-</div>
        </div>
        <div class="coord-box">
          <div class="coord-label">Speed (km/h)</div>
          <div class="coord-value" id="speed">0</div>
        </div>
        <div class="coord-box">
          <div class="coord-label">Heading (¬∞)</div>
          <div class="coord-value" id="heading">0</div>
        </div>
      </div>

      <button class="btn btn-primary" id="startBtn" onclick="start()">
        üöÄ Start GPS Tracking
      </button>
      <button
        class="btn btn-danger"
        id="stopBtn"
        onclick="stop()"
        style="display: none"
      >
        ‚èπÔ∏è Stop Tracking
      </button>

      <h3 style="margin: 20px 0 10px 0; color: #4a5568">üìä Event Log</h3>
      <div class="log" id="log"></div>
    </div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
      let socket = null;
      let watchId = null;
      let updateCount = 0;
      let lastPosition = null;
      let lastTime = null;

      function log(message, type = "info") {
        const logDiv = document.getElementById("log");
        const timestamp = new Date().toLocaleTimeString();
        const logItem = document.createElement("div");
        logItem.className = `log-item ${type}`;
        logItem.innerHTML = `<span class="timestamp">[${timestamp}]</span>${message}`;
        logDiv.insertBefore(logItem, logDiv.firstChild);

        // Keep only last 50 logs
        while (logDiv.children.length > 50) {
          logDiv.removeChild(logDiv.lastChild);
        }
      }

      function calculateSpeed(lat1, lng1, lat2, lng2, timeDiffSeconds) {
        // Haversine distance in meters
        const R = 6371e3;
        const œÜ1 = (lat1 * Math.PI) / 180;
        const œÜ2 = (lat2 * Math.PI) / 180;
        const ŒîœÜ = ((lat2 - lat1) * Math.PI) / 180;
        const ŒîŒª = ((lng2 - lng1) * Math.PI) / 180;

        const a =
          Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) +
          Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        const distance = R * c;

        // Speed in km/h
        const speedMps = distance / timeDiffSeconds;
        return speedMps * 3.6;
      }

      function calculateHeading(lat1, lng1, lat2, lng2) {
        const œÜ1 = (lat1 * Math.PI) / 180;
        const œÜ2 = (lat2 * Math.PI) / 180;
        const ŒîŒª = ((lng2 - lng1) * Math.PI) / 180;

        const y = Math.sin(ŒîŒª) * Math.cos(œÜ2);
        const x =
          Math.cos(œÜ1) * Math.sin(œÜ2) -
          Math.sin(œÜ1) * Math.cos(œÜ2) * Math.cos(ŒîŒª);
        const Œ∏ = Math.atan2(y, x);
        const bearing = ((Œ∏ * 180) / Math.PI + 360) % 360;

        return bearing;
      }

      function start() {
        const tripId = document.getElementById("tripId").value;
        const token = document.getElementById("token").value;
        const wsUrl = document.getElementById("wsUrl").value;

        if (!tripId || !token) {
          alert("Vui l√≤ng nh·∫≠p Trip ID v√† Access Token!");
          return;
        }

        // Update UI
        document.getElementById("startBtn").disabled = true;
        document.getElementById("stopBtn").style.display = "block";

        log("üîå Connecting to WebSocket...", "info");

        // Connect WebSocket
        socket = io(wsUrl, {
          auth: { token },
          transports: ["websocket", "polling"],
        });

        socket.on("connect", () => {
          log("‚úÖ WebSocket connected! Socket ID: " + socket.id, "success");
          document.getElementById("wsStatus").textContent = "Connected";
          document.getElementById("wsStatus").className =
            "status-value connected";

          // Join trip room
          socket.emit("join_trip", parseInt(tripId));
          log(`üìç Joined trip-${tripId} room`, "success");
        });

        socket.on("connect_error", (error) => {
          log("‚ùå WebSocket error: " + error.message, "error");
          document.getElementById("wsStatus").textContent = "Error";
          document.getElementById("wsStatus").className =
            "status-value disconnected";
        });

        socket.on("disconnect", (reason) => {
          log("üî¥ WebSocket disconnected: " + reason, "warning");
          document.getElementById("wsStatus").textContent = "Disconnected";
          document.getElementById("wsStatus").className =
            "status-value disconnected";
        });

        socket.on("gps_ack", (data) => {
          if (data.success) {
            log(
              "‚úÖ Server ACK: " + (data.events?.join(", ") || "OK"),
              "success"
            );
          } else {
            log("‚ùå Server error: " + data.error, "error");
          }
        });

        socket.on("bus_position_update", (data) => {
          log(`üì° Received bus_position_update: Trip ${data.tripId}`, "info");
        });

        socket.on("approach_stop", (data) => {
          log(
            `üöè ‚ö†Ô∏è  APPROACHING STOP: ${data.stopName} (${data.distance_m}m)`,
            "warning"
          );
        });

        socket.on("delay_alert", (data) => {
          log(
            `‚è∞ ‚ö†Ô∏è  DELAY ALERT: ${
              data.delayMinutes || data.delay_minutes
            } minutes late`,
            "warning"
          );
        });

        // Start GPS tracking
        if (!navigator.geolocation) {
          log("‚ùå Geolocation not supported by browser", "error");
          alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Geolocation!");
          stop();
          return;
        }

        log("üìç Requesting GPS permission...", "info");

        watchId = navigator.geolocation.watchPosition(
          (position) => {
            const now = Date.now();
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy;

            // Update UI
            document.getElementById("gpsStatus").textContent = "Active";
            document.getElementById("gpsStatus").className =
              "status-value connected";
            document.getElementById("lat").textContent = lat.toFixed(6);
            document.getElementById("lng").textContent = lng.toFixed(6);
            document.getElementById("accuracy").textContent =
              accuracy.toFixed(1) + "m";

            // Calculate speed and heading
            let speed = 0;
            let heading = 0;

            if (lastPosition && lastTime) {
              const timeDiff = (now - lastTime) / 1000; // seconds
              speed = calculateSpeed(
                lastPosition.lat,
                lastPosition.lng,
                lat,
                lng,
                timeDiff
              );
              heading = calculateHeading(
                lastPosition.lat,
                lastPosition.lng,
                lat,
                lng
              );
            }

            // Update UI
            document.getElementById("speed").textContent = speed.toFixed(1);
            document.getElementById("heading").textContent =
              Math.round(heading);

            // Send GPS update via WebSocket
            if (socket && socket.connected) {
              const gpsData = {
                tripId: parseInt(tripId),
                lat: lat,
                lng: lng,
                speedKph: Math.round(speed * 10) / 10,
                heading: Math.round(heading),
                tsClient: new Date().toISOString(),
              };

              socket.emit("gps:update", gpsData);
              updateCount++;
              document.getElementById("updateCount").textContent = updateCount;

              log(
                `üì§ GPS sent: (${lat.toFixed(6)}, ${lng.toFixed(
                  6
                )}) | Speed: ${speed.toFixed(
                  1
                )} km/h | Heading: ${heading.toFixed(0)}¬∞`,
                "info"
              );
            }

            // Update last position
            lastPosition = { lat, lng };
            lastTime = now;
          },
          (error) => {
            log("‚ùå GPS error: " + error.message, "error");
            document.getElementById("gpsStatus").textContent = "Error";
            document.getElementById("gpsStatus").className =
              "status-value disconnected";

            if (error.code === error.PERMISSION_DENIED) {
              alert(
                "B·∫°n ƒë√£ t·ª´ ch·ªëi quy·ªÅn truy c·∫≠p v·ªã tr√≠!\n\nVui l√≤ng:\n1. V√†o Settings > Privacy > Location\n2. Cho ph√©p tr√¨nh duy·ªát truy c·∫≠p v·ªã tr√≠\n3. T·∫£i l·∫°i trang v√† th·ª≠ l·∫°i"
              );
              stop();
            }
          },
          {
            enableHighAccuracy: true,
            timeout: 5000,
            maximumAge: 0,
          }
        );

        log("‚úÖ GPS tracking started", "success");
      }

      function stop() {
        if (watchId !== null) {
          navigator.geolocation.clearWatch(watchId);
          watchId = null;
          log("‚èπÔ∏è GPS tracking stopped", "warning");
        }

        if (socket) {
          socket.disconnect();
          socket = null;
          log("üîå WebSocket disconnected", "warning");
        }

        // Reset UI
        document.getElementById("startBtn").disabled = false;
        document.getElementById("stopBtn").style.display = "none";
        document.getElementById("wsStatus").textContent = "Disconnected";
        document.getElementById("wsStatus").className =
          "status-value disconnected";
        document.getElementById("gpsStatus").textContent = "Inactive";
        document.getElementById("gpsStatus").className =
          "status-value disconnected";

        updateCount = 0;
        lastPosition = null;
        lastTime = null;
      }

      // Handle page unload
      window.addEventListener("beforeunload", () => {
        stop();
      });

      // Initial log
      log("üëã Welcome to Real GPS Test!", "success");
      log("üìñ Instructions:", "info");
      log("1Ô∏è‚É£ Login as driver to get JWT token", "info");
      log("2Ô∏è‚É£ Paste token above and enter Trip ID", "info");
      log('3Ô∏è‚É£ Click "Start GPS Tracking"', "info");
      log("4Ô∏è‚É£ Allow location permission when prompted", "info");
      log("5Ô∏è‚É£ Move around and watch the updates!", "info");
    </script>
  </body>
</html>
