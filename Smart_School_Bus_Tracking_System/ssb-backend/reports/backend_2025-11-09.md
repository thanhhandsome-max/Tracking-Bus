# backend_09/11 — Backend Audit v1.1

**Ngày audit:** 09/11/2025  
**Phiên bản:** v1.1  
**Phạm vi:** Toàn bộ `ssb-backend/` (src, routes, controllers, services, models, middlewares, docs, tests, scripts, CI/Docker/ENV)

---

## 1. Summary

### 1.1. Trạng thái tổng quan

Backend đã được refactor theo v1.1 với các thay đổi chính:
- ✅ Database schema ver2: DiemDung đã được normalize, không còn `maTuyen`/`thuTu`, sử dụng `route_stops` junction table
- ✅ Maps API proxy: 5 endpoints với cache (Redis/Memory fallback) và rate limiting
- ✅ Route management: Sử dụng `route_stops` để quản lý stops, có rebuild-polyline endpoint
- ✅ OpenAPI v1.1: Spec đầy đủ với schemas và examples
- ✅ Tests: Có integration tests cho routes và maps API
- ✅ CI/CD: GitHub Actions workflow với MySQL + Redis
- ⚠️ **Vấn đề phát hiện:** ValidationMiddleware vẫn yêu cầu `thuTu` trong validateStop (không khớp với schema ver2)

### 1.2. Điểm mạnh

1. **Database Schema Alignment (ver2):**
   - ✅ DiemDung không còn `maTuyen`/`thuTu`
   - ✅ `route_stops` junction table với `sequence`, `dwell_seconds`
   - ✅ TuyenDuong có `origin_lat`, `origin_lng`, `dest_lat`, `dest_lng`, `polyline`
   - ✅ Index `idx_route_seq(route_id, sequence)` được khai báo

2. **Maps API Proxy:**
   - ✅ 5 endpoints: directions, distance-matrix, geocode, reverse-geocode, roads/snap
   - ✅ Cache provider abstraction (Redis + Memory fallback)
   - ✅ TTL được cấu hình đúng: Directions 6h, Matrix 2m, Geocode 24h, Roads 15m
   - ✅ Rate limiting: Matrix ≤60 req/min, Directions ≤30 req/min
   - ✅ Response có `cached: true|false`

3. **Rebuild Polyline:**
   - ✅ Endpoint `POST /api/v1/routes/:id/rebuild-polyline`
   - ✅ Lấy origin (MIN sequence), destination (MAX), waypoints (ở giữa)
   - ✅ Gọi Maps API và lưu polyline vào DB
   - ✅ Xử lý lỗi đầy đủ (404, 400, 503, 500)

4. **OpenAPI & Postman:**
   - ✅ OpenAPI spec v1.1 với đầy đủ schemas
   - ✅ Có Postman collection export script
   - ✅ Schemas: Route, Stop, RouteStop, RouteDetail, Create*/Update*, ReorderStopsPayload, Maps APIs

5. **Tests & CI:**
   - ✅ Integration tests cho routes (getById, reorder, rebuild-polyline)
   - ✅ Tests cho Maps API (cache, rate limiting)
   - ✅ CI workflow với MySQL 8.0 + Redis 7
   - ⚠️ Jest config có warning về `extensionsToTreatAsEsm`

6. **ENV & Config:**
   - ✅ env.example có đầy đủ biến (DB, JWT, Cache, Maps, Rate Limit)
   - ✅ Cache driver fallback (memory khi Redis không khả dụng)
   - ✅ CORS configuration đồng bộ (FE_ORIGIN, SOCKET_CORS_ORIGIN)

### 1.3. Điểm cần cải thiện (ưu tiên)

#### P0 (Critical - Phải sửa ngay):
1. **ValidationMiddleware.validateStop** yêu cầu `thuTu` nhưng schema ver2 không có field này trong DiemDung. Nên yêu cầu `sequence` trong body khi thêm stop vào route (sequence nằm trong route_stops, không phải DiemDung).

#### P1 (High - Nên sửa sớm):
1. **Jest config:** Warning về `extensionsToTreatAsEsm: ['.js']` - cần cập nhật config
2. **Tests:** Chưa có tests cho tất cả endpoints (chỉ có routes và maps)
3. **Rate limiting:** Chưa test được rate limiting (cần mock hoặc thực tế)

#### P2 (Medium - Có thể để sau):
1. **Performance:** Chưa có metrics P50/P95 (cần middleware timing)
2. **Documentation:** Chưa có EXPLAIN query logs để verify index usage
3. **Socket.IO:** Rebuild polyline chưa publish route-updates qua socket/pubsub

---

## 2. Checklist Pass/Fail

### 2.1. DB Schema Alignment (ver2)

**Status: ⚠️ PARTIAL PASS**

#### ✅ PASS:
- [x] DiemDung không còn `maTuyen`/`thuTu` (schema ver2)
- [x] `route_stops` junction table có `sequence`, `dwell_seconds`
- [x] TuyenDuong có `origin_lat`, `origin_lng`, `dest_lat`, `dest_lng`, `polyline`
- [x] RouteStopModel.getByRouteId() trả về stops ORDER BY `route_stops.sequence`
- [x] Query đúng format: `SELECT d.*, rs.sequence, rs.dwell_seconds FROM route_stops rs JOIN DiemDung d ON d.maDiem = rs.stop_id WHERE rs.route_id = ? ORDER BY rs.sequence`
- [x] Index `idx_route_seq(route_id, sequence)` được khai báo

#### ❌ FAIL:
- [ ] **ValidationMiddleware.validateStop** (line 299-302): Vẫn yêu cầu `thuTu` - không khớp với schema ver2
  - **File:** `ssb-backend/src/middlewares/ValidationMiddleware.js:299`
  - **Vấn đề:** Schema ver2 không có `thuTu` trong DiemDung. Khi thêm stop vào route, `sequence` nằm trong `route_stops`, không phải trong body của DiemDung.
  - **Đề xuất:** Sửa validation để:
    - Khi tạo stop độc lập: không yêu cầu `thuTu`
    - Khi thêm stop vào route: yêu cầu `sequence` (optional, auto-increment nếu không có)

#### ⚠️ WARNING:
- [ ] `maTuyen` được sử dụng trong nhiều nơi (LichTrinhModel, ChuyenDiModel, ScheduleController, etc.) - **Đây là OK** vì `maTuyen` là ID của TuyenDuong (route), không phải field trong DiemDung
- [ ] `thuTu` được sử dụng trong ValidationMiddleware và validate.ts - **Cần sửa** để khớp với schema ver2

### 2.2. 6 API Proxy (Google Maps)

**Status: ✅ PASS**

#### ✅ PASS:
- [x] **Endpoints:**
  - `POST /api/v1/maps/directions` ✅
  - `POST /api/v1/maps/distance-matrix` ✅
  - `POST /api/v1/maps/geocode` ✅
  - `POST /api/v1/maps/reverse-geocode` ✅
  - `POST /api/v1/maps/roads/snap` ✅

- [x] **Cache & TTL:**
  - Directions: TTL 6h (CACHE_TTL_DIRECTIONS=21600) ✅
  - Distance Matrix: TTL 2m (CACHE_TTL_DISTANCE_MATRIX=120) ✅
  - Geocode: TTL 24h (CACHE_TTL_GEOCODE=86400) ✅
  - Roads: TTL 15m (CACHE_TTL_ROADS=900) ✅
  - Response có `cached: true|false` ✅

- [x] **Cache Provider:**
  - MapsService sử dụng `getCacheProvider()` ✅
  - Memory fallback khi Redis không khả dụng ✅
  - Cache key generation với hash ✅

- [x] **Rate Limiting:**
  - Matrix: ≤60 req/phút (RL_MAX_MATRIX=60) ✅
  - Directions: ≤30 req/phút (RL_MAX_DIRECTIONS=30) ✅
  - Geocode: ≤60 req/phút (RL_MAX_MATRIX=60) ✅
  - Roads: ≤30 req/phút (RL_MAX_DIRECTIONS=30) ✅
  - Rate limiter sử dụng IP + body hash ✅
  - Response 429 khi vượt ngưỡng ✅

#### ⚠️ WARNING:
- [ ] Chưa test được cache thực tế (cần mock hoặc test với server thật)
- [ ] Chưa test được rate limiting thực tế (cần spam requests)

### 2.3. Rebuild Polyline Flow

**Status: ✅ PASS**

#### ✅ PASS:
- [x] Endpoint: `POST /api/v1/routes/:id/rebuild-polyline` ✅
- [x] Lấy stops từ `route_stops` ORDER BY sequence ✅
- [x] Origin = stop có MIN(sequence) ✅
- [x] Destination = stop có MAX(sequence) ✅
- [x] Waypoints = stops ở giữa ✅
- [x] Gọi MapsService.getDirections() ✅
- [x] Lưu polyline vào DB (TuyenDuong.polyline) ✅
- [x] Xử lý lỗi: 404 (ROUTE_NOT_FOUND), 400 (INSUFFICIENT_STOPS), 503 (MAPS_API_ERROR), 500 ✅

#### ⚠️ WARNING:
- [ ] Chưa publish route-updates qua socket/pubsub (theo yêu cầu)
- [ ] Chưa có batch rebuild cho nhiều routes

### 2.4. OpenAPI v1.1 & Postman

**Status: ✅ PASS**

#### ✅ PASS:
- [x] OpenAPI spec v1.1: `docs/openapi.yaml` ✅
- [x] Schemas đầy đủ:
  - Route, Stop, RouteStop, RouteDetail ✅
  - CreateRoutePayload, UpdateRoutePayload ✅
  - CreateStopPayload, UpdateStopPayload ✅
  - ReorderStopsPayload ✅
  - DirectionsRequest/Response, DistanceMatrixRequest/Response, GeocodeRequest/Response, RoadsSnapRequest/Response ✅

- [x] Paths khớp code:
  - `/routes` (GET, POST) ✅
  - `/routes/{id}` (GET, PUT, DELETE) ✅
  - `/routes/{id}/stops` (GET, POST) ✅
  - `/routes/{id}/stops/{stopId}` (DELETE) ✅
  - `/routes/{id}/stops/reorder` (PATCH) ✅
  - `/routes/{id}/rebuild-polyline` (POST) ✅
  - `/maps/directions` (POST) ✅
  - `/maps/distance-matrix` (POST) ✅
  - `/maps/geocode` (POST) ✅
  - `/maps/reverse-geocode` (POST) ✅
  - `/maps/roads/snap` (POST) ✅

- [x] Response codes: 200/201/204/400/404/409/429/500 ✅
- [x] Examples có trong spec ✅
- [x] Postman collection export script: `scripts/export-postman.js` ✅

#### ⚠️ WARNING:
- [ ] Chưa verify Postman collection có 20 requests, 3 groups
- [ ] Chưa test import Postman collection

### 2.5. Tests & CI

**Status: ⚠️ PARTIAL PASS**

#### ✅ PASS:
- [x] Integration tests: `tests/routes.test.js` ✅
  - GET /routes/:id trả stops đúng order ✅
  - Reorder stops ✅
  - Rebuild polyline (mock Google) ✅
  - Matrix cache: lần 2 cached: true ✅

- [x] CI workflow: `.github/workflows/ci.yml` ✅
  - Node.js LTS (20) ✅
  - MySQL 8.0 ✅
  - Redis 7 ✅
  - Lint ✅
  - Test ✅

#### ❌ FAIL:
- [ ] **Jest config:** Warning về `extensionsToTreatAsEsm: ['.js']`
  - **File:** `ssb-backend/jest.config.js:4`
  - **Vấn đề:** Jest warning: "Option: extensionsToTreatAsEsm: ['.js'] includes '.js' which is always inferred based on type in its nearest package.json"
  - **Đề xuất:** Xóa dòng `extensionsToTreatAsEsm: [".js"]` hoặc cập nhật config

#### ⚠️ WARNING:
- [ ] Chưa có tests cho tất cả endpoints (chỉ có routes và maps)
- [ ] Chưa có unit tests cho services/models
- [ ] Chưa có tests cho rate limiting thực tế

### 2.6. ENV & Config

**Status: ✅ PASS**

#### ✅ PASS:
- [x] env.example có đầy đủ biến:
  - DB_* (HOST, PORT, USER, PASSWORD, NAME) ✅
  - JWT_* (SECRET, REFRESH_SECRET, EXPIRES_IN) ✅
  - CACHE_DRIVER, REDIS_URL, REDIS_HOST, REDIS_PORT, REDIS_PASSWORD ✅
  - CACHE_TTL_* (DIRECTIONS, DISTANCE_MATRIX, GEOCODE, ROADS) ✅
  - MAPS_API_KEY ✅
  - RL_* (WINDOW, MAX_MATRIX, MAX_DIRECTIONS) ✅
  - FE_ORIGIN, SOCKET_CORS_ORIGIN ✅
  - API_PREFIX ✅

- [x] Biến bắt buộc được kiểm tra:
  - `src/config/env.ts` kiểm tra: PORT, DB_HOST, DB_USER, DB_NAME, JWT_SECRET, JWT_REFRESH_SECRET, FE_ORIGIN ✅

- [x] Cache driver fallback:
  - CACHE_DRIVER=memory hoạt động khi Redis không khả dụng ✅
  - MemoryCache sử dụng LRU cache ✅

- [x] CORS đồng bộ:
  - FE_ORIGIN (comma-separated) ✅
  - SOCKET_CORS_ORIGIN (falls back to FE_ORIGIN) ✅

#### ⚠️ WARNING:
- [ ] Chưa kiểm tra biến thừa: REDIS_HOST/PORT/PASSWORD (có trong env.example nhưng optional)
- [ ] Chưa kiểm tra API_VERSION, MAPS_PROVIDER (không có trong code, không cần)

### 2.7. Mini Performance Check

**Status: ⚠️ NOT TESTED**

#### ⚠️ WARNING:
- [ ] Chưa test Matrix 10 lần/60s cùng payload → chỉ 1 lần hit Google
- [ ] Chưa đo GET /routes/:id với ≥5 stops (P50/P95)
- [ ] Chưa có middleware timing để log thời gian thực thi

---

## 3. Findings (file/dòng)

### 3.1. Critical Issues (P0)

#### [P0] ValidationMiddleware.validateStop yêu cầu `thuTu` (không khớp schema ver2)
- **File:** `ssb-backend/src/middlewares/ValidationMiddleware.js:299-302`
- **Vấn đề:**
  ```javascript
  thuTu: Joi.number().integer().min(1).required().messages({
    "number.min": "Thứ tự phải là số nguyên dương",
    "any.required": "Thứ tự là bắt buộc",
  }),
  ```
  Schema ver2 không có `thuTu` trong DiemDung. Khi thêm stop vào route, `sequence` nằm trong `route_stops`, không phải trong body của DiemDung.

- **Ảnh hưởng:**
  - API `POST /api/v1/routes/:id/stops` sẽ reject request nếu không có `thuTu`
  - Không khớp với schema ver2 (DiemDung độc lập, sequence nằm trong route_stops)

- **Đề xuất sửa:**
  - Sửa `ValidationMiddleware.validateStop` để không yêu cầu `thuTu`
  - Thêm validation riêng cho `sequence` khi thêm stop vào route (optional, auto-increment nếu không có)
  - Hoặc tách validation: `validateStop` (cho DiemDung) và `validateRouteStop` (cho route_stops)

### 3.2. High Priority Issues (P1)

#### [P1] Jest config warning về extensionsToTreatAsEsm
- **File:** `ssb-backend/jest.config.js:4`
- **Vấn đề:**
  ```
  Validation Error:
  Option: extensionsToTreatAsEsm: ['.js'] includes '.js' which is always inferred based on type in its nearest package.json.
  ```
- **Đề xuất sửa:**
  - Xóa dòng `extensionsToTreatAsEsm: [".js"]` từ jest.config.js
  - Hoặc cập nhật Jest config theo best practices cho ESM

#### [P1] Chưa có tests đầy đủ
- **File:** `ssb-backend/tests/`
- **Vấn đề:**
  - Chỉ có tests cho routes và maps API
  - Chưa có tests cho stops, schedules, trips, etc.
  - Chưa có unit tests cho services/models
- **Đề xuất:**
  - Thêm tests cho tất cả endpoints
  - Thêm unit tests cho services/models
  - Thêm tests cho rate limiting thực tế

### 3.3. Medium Priority Issues (P2)

#### [P2] Rebuild polyline chưa publish route-updates qua socket/pubsub
- **File:** `ssb-backend/src/services/RouteService.js:161-201`
- **Vấn đề:**
  - Rebuild polyline chỉ lưu vào DB, chưa publish event qua socket/pubsub
- **Đề xuất:**
  - Thêm socket emit hoặc pubsub khi rebuild polyline thành công
  - Event: `route-updated` hoặc `polyline-rebuilt`

#### [P2] Chưa có metrics P50/P95
- **File:** `ssb-backend/src/`
- **Vấn đề:**
  - Chưa có middleware timing để đo thời gian thực thi
  - Chưa có metrics P50/P95 cho API endpoints
- **Đề xuất:**
  - Thêm middleware timing (ví dụ: `express-response-time`)
  - Log thời gian thực thi và tính P50/P95
  - Thêm endpoint `/metrics` để expose metrics

#### [P2] Chưa có EXPLAIN query logs
- **File:** `ssb-backend/src/models/RouteStopModel.js:13-32`
- **Vấn đề:**
  - Chưa verify index `idx_route_seq(route_id, sequence)` được sử dụng
- **Đề xuất:**
  - Thêm script để chạy EXPLAIN query
  - Verify index usage khi query route stops

### 3.4. Code Quality Issues

#### ValidationMiddleware.validateStop sử dụng `thuTu` thay vì `sequence`
- **File:** `ssb-backend/src/middlewares/ValidationMiddleware.js:299`
- **File:** `ssb-backend/src/middlewares/validate.ts:217`
- **Vấn đề:**
  - Cả 2 file đều yêu cầu `thuTu` trong validation
  - Không khớp với schema ver2 (sequence nằm trong route_stops)

#### RouteController.addStopToRoute chấp nhận `sequence` trong body
- **File:** `ssb-backend/src/controllers/RouteController.js:348`
- **Vấn đề:**
  - Controller chấp nhận `sequence` trong body (đúng)
  - Nhưng ValidationMiddleware yêu cầu `thuTu` (sai)
  - Conflict giữa validation và controller logic

---

## 4. Proposed Fixes (không áp dụng tự động)

### 4.1. [P0] Sửa ValidationMiddleware.validateStop

**File:** `ssb-backend/src/middlewares/ValidationMiddleware.js`

**Diff:**
```diff
  // Validate stop data
  static validateStop(req, res, next) {
    const schema = Joi.object({
      tenDiem: Joi.string().min(2).max(255).required().messages({
        "string.min": "Tên điểm dừng phải có ít nhất 2 ký tự",
        "string.max": "Tên điểm dừng không được quá 255 ký tự",
        "any.required": "Tên điểm dừng là bắt buộc",
      }),
      diaChi: Joi.string().max(255).optional(),
      viDo: Joi.number().min(-90).max(90).required().messages({
        "number.min": "Vĩ độ phải từ -90 đến 90",
        "number.max": "Vĩ độ phải từ -90 đến 90",
        "any.required": "Vĩ độ là bắt buộc",
      }),
      kinhDo: Joi.number().min(-180).max(180).required().messages({
        "number.min": "Kinh độ phải từ -180 đến 180",
        "number.max": "Kinh độ phải từ -180 đến 180",
        "any.required": "Kinh độ là bắt buộc",
      }),
-     thuTu: Joi.number().integer().min(1).required().messages({
-       "number.min": "Thứ tự phải là số nguyên dương",
-       "any.required": "Thứ tự là bắt buộc",
-     }),
+     // thuTu removed - không còn trong DiemDung (schema ver2)
+     // sequence nằm trong route_stops, không phải DiemDung
+     sequence: Joi.number().integer().min(1).optional().messages({
+       "number.min": "Thứ tự phải là số nguyên dương",
+     }),
+     stop_id: Joi.number().integer().positive().optional().messages({
+       "number.positive": "Mã điểm dừng phải là số nguyên dương",
+     }),
+     dwell_seconds: Joi.number().integer().min(0).optional().messages({
+       "number.min": "Thời gian dừng phải >= 0",
+     }),
      thoiGianDungChan: Joi.number().integer().min(0).optional().messages({
        "number.min": "Thời gian dừng chân phải >= 0",
      }),
    });
```

**Giải thích:**
- Xóa `thuTu` (không còn trong DiemDung)
- Thêm `sequence` (optional, auto-increment nếu không có)
- Thêm `stop_id` (optional, để thêm stop hiện có vào route)
- Thêm `dwell_seconds` (optional, thời gian dừng tại stop)

### 4.2. [P1] Sửa Jest config

**File:** `ssb-backend/jest.config.js`

**Diff:**
```diff
export default {
  testEnvironment: "node",
  transform: {},
- extensionsToTreatAsEsm: [".js"],
  moduleNameMapper: {
    "^(\\.{1,2}/.*)\\.js$": "$1",
  },
  testMatch: ["**/__tests__/**/*.js", "**/?(*.)+(spec|test).js"],
  collectCoverageFrom: ["src/**/*.js", "!src/**/*.test.js"],
  coverageDirectory: "coverage",
  verbose: true,
};
```

**Giải thích:**
- Xóa `extensionsToTreatAsEsm: [".js"]` vì Jest tự infer từ package.json (`"type": "module"`)

### 4.3. [P2] Thêm socket emit khi rebuild polyline

**File:** `ssb-backend/src/services/RouteService.js`

**Diff:**
```diff
  /**
   * Rebuild polyline cho route (dùng Maps API)
   */
  static async rebuildPolyline(routeId, mapsService) {
    const route = await TuyenDuongModel.getById(routeId);
    if (!route) throw new Error("ROUTE_NOT_FOUND");

    const stops = await RouteStopModel.getByRouteId(routeId);
    if (stops.length < 2) {
      throw new Error("INSUFFICIENT_STOPS");
    }

    // Origin = stop đầu tiên
    const origin = `${stops[0].viDo},${stops[0].kinhDo}`;
    // Destination = stop cuối cùng
    const destination = `${stops[stops.length - 1].viDo},${stops[stops.length - 1].kinhDo}`;
    // Waypoints = các stop ở giữa
    const waypoints = stops.slice(1, -1).map((stop) => ({
      location: `${stop.viDo},${stop.kinhDo}`,
    }));

    // Gọi Maps API
    const directionsResult = await mapsService.getDirections({
      origin,
      destination,
      waypoints: waypoints.length > 0 ? waypoints : undefined,
      mode: "driving",
    });

    if (!directionsResult.polyline) {
      throw new Error("MAPS_API_ERROR");
    }

    // Cập nhật polyline vào DB
    await TuyenDuongModel.update(routeId, {
      polyline: directionsResult.polyline,
    });

+   // Publish route-updates qua socket/pubsub (nếu có)
+   // TODO: Implement socket emit hoặc pubsub
+   // io.emit('route-updated', { routeId, polyline: directionsResult.polyline });

    return {
      polyline: directionsResult.polyline,
      updated: true,
      cached: directionsResult.cached || false,
    };
  }
```

**Giải thích:**
- Thêm comment về socket emit (chưa implement)
- Cần import socket.io instance và emit event `route-updated`

### 4.4. [P2] Thêm middleware timing

**File:** `ssb-backend/src/middlewares/timing.js` (mới)

**Code:**
```javascript
import { performance } from 'perf_hooks';

/**
 * Middleware để đo thời gian thực thi request
 */
export const timingMiddleware = (req, res, next) => {
  const start = performance.now();
  
  res.on('finish', () => {
    const duration = performance.now() - start;
    console.log(`[TIMING] ${req.method} ${req.path} - ${duration.toFixed(2)}ms`);
    
    // TODO: Thêm metrics vào Prometheus/StatsD
    // metrics.histogram('http_request_duration_ms', duration, {
    //   method: req.method,
    //   path: req.path,
    //   status: res.statusCode,
    // });
  });
  
  next();
};

export default timingMiddleware;
```

**Sử dụng trong app.js:**
```javascript
import timingMiddleware from './middlewares/timing.js';
app.use(timingMiddleware);
```

---

## 5. Next Steps

### 5.1. Ưu tiên cao (P0 - P1)

1. **Sửa ValidationMiddleware.validateStop** (P0)
   - Xóa `thuTu`, thêm `sequence` (optional)
   - Test lại API `POST /api/v1/routes/:id/stops`

2. **Sửa Jest config** (P1)
   - Xóa `extensionsToTreatAsEsm: [".js"]`
   - Chạy lại tests để verify

3. **Thêm tests đầy đủ** (P1)
   - Tests cho stops, schedules, trips
   - Unit tests cho services/models
   - Tests cho rate limiting thực tế

### 5.2. Ưu tiên trung bình (P2)

4. **Thêm socket emit khi rebuild polyline** (P2)
   - Import socket.io instance
   - Emit event `route-updated` khi rebuild polyline thành công

5. **Thêm metrics P50/P95** (P2)
   - Middleware timing
   - Log thời gian thực thi
   - Tính P50/P95

6. **Verify index usage** (P2)
   - Script EXPLAIN query
   - Verify `idx_route_seq` được sử dụng

### 5.3. Cải thiện khác

7. **Performance testing**
   - Test Matrix 10 lần/60s cùng payload
   - Test GET /routes/:id với ≥5 stops
   - Đo latency và throughput

8. **Documentation**
   - Cập nhật API documentation
   - Thêm examples cho tất cả endpoints
   - Thêm troubleshooting guide

9. **Monitoring**
   - Thêm health check endpoint
   - Thêm metrics endpoint
   - Thêm logging cho errors

---

## 6. Kết luận

### 6.1. Tổng kết

Backend v1.1 đã được refactor đúng hướng với:
- ✅ Database schema ver2 (DiemDung normalize, route_stops junction table)
- ✅ Maps API proxy với cache và rate limiting
- ✅ Rebuild polyline endpoint
- ✅ OpenAPI v1.1 spec đầy đủ
- ✅ Tests và CI workflow

**Vấn đề chính:**
- ⚠️ ValidationMiddleware.validateStop vẫn yêu cầu `thuTu` (không khớp schema ver2)
- ⚠️ Jest config có warning
- ⚠️ Chưa có tests đầy đủ

### 6.2. Đánh giá

**Điểm mạnh:**
- Architecture tốt (service layer, model layer, controller layer)
- Cache và rate limiting được implement đúng
- Database schema ver2 được áp dụng đúng
- OpenAPI spec đầy đủ

**Điểm yếu:**
- Validation không khớp với schema ver2
- Tests chưa đầy đủ
- Chưa có metrics và monitoring

### 6.3. Khuyến nghị

1. **Sửa ngay (P0):**
   - ValidationMiddleware.validateStop

2. **Sửa sớm (P1):**
   - Jest config
   - Thêm tests đầy đủ

3. **Cải thiện (P2):**
   - Socket emit khi rebuild polyline
   - Metrics P50/P95
   - Verify index usage

---

**Báo cáo được tạo bởi:** Backend Audit Tool  
**Ngày:** 09/11/2025  
**Phiên bản:** v1.1

