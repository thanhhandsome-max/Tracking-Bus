# BÃO CÃO KIá»‚M TRA CHI TIáº¾T - 1.4
## Cáº¬P NHáº¬T Vá»Š TRÃ Cá»¦A CÃC XE BUÃT THEO THá»œI GIAN THá»°C (Tá»I ÄA Äá»˜ TRá»„ 3 GIÃ‚Y)

**NgÃ y kiá»ƒm tra:** 2025-11-12  
**PhiÃªn báº£n:** 1.0  
**YÃªu cáº§u:** YeuCauDoAn.md - Chá»©c nÄƒng Quáº£n lÃ½ xe buÃ½t (1.4)

---

## ğŸ“‹ TÃ“M Táº®T

**Tráº¡ng thÃ¡i:** âœ… **HOÃ€N THÃ€NH Äáº¦Y Äá»¦**

Há»‡ thá»‘ng Ä‘Ã£ triá»ƒn khai Ä‘áº§y Ä‘á»§ chá»©c nÄƒng cáº­p nháº­t vá»‹ trÃ­ xe buÃ½t theo thá»i gian thá»±c vá»›i:
- âœ… **Rate limiting:** 2 giÃ¢y (Ä‘áº£m báº£o â‰¤ 3 giÃ¢y yÃªu cáº§u)
- âœ… **In-memory cache:** Map lÆ°u vá»‹ trÃ­ real-time
- âœ… **Socket.IO:** Broadcast real-time Ä‘áº¿n nhiá»u rooms
- âœ… **Frontend:** Gá»­i GPS má»—i 3 giÃ¢y, nháº­n updates real-time
- âœ… **Validation:** Kiá»ƒm tra lat/lng há»£p lá»‡
- âœ… **Geofence & Delay:** Tá»± Ä‘á»™ng phÃ¡t hiá»‡n vÃ  emit events

**Kiáº¿n trÃºc:**
- Socket.IO vá»›i WebSocket transport
- In-memory cache (Map) cho vá»‹ trÃ­ xe
- Broadcast Ä‘áº¿n multiple rooms Ä‘á»ƒ giáº£m latency
- Rate limiting Ä‘á»ƒ trÃ¡nh spam vÃ  Ä‘áº£m báº£o â‰¤ 3s delay

---

## ğŸ—„ï¸ PHáº¦N 1: DATABASE (SQL)

### 1.1. LÆ°u trá»¯ vá»‹ trÃ­

**KhÃ´ng cÃ³ báº£ng riÃªng lÆ°u vá»‹ trÃ­ GPS trong database**

**LÃ½ do:**
- Vá»‹ trÃ­ GPS thay Ä‘á»•i liÃªn tá»¥c (má»—i 2-3 giÃ¢y)
- LÆ°u vÃ o database sáº½ táº¡o quÃ¡ nhiá»u records
- In-memory cache (Map) Ä‘á»§ nhanh cho real-time tracking
- CÃ³ thá»ƒ sync sang Firebase Realtime Database (optional)

**Cáº¥u trÃºc cache (In-memory):**
```javascript
// Structure trong TelemetryService
busPositions = Map {
  "bus-1": {
    lat: 21.0285,
    lng: 105.8542,
    speed: 30,
    heading: 90,
    timestamp: "2025-10-29T12:30:00Z",
    tripId: 42,
    busId: 1
  },
  "bus-2": { ... }
}
```

**ÄÃ¡nh giÃ¡:**
- âœ… **PhÃ¹ há»£p:** In-memory cache Ä‘á»§ nhanh cho real-time
- âœ… **Hiá»‡u quáº£:** O(1) lookup vá»›i Map
- âš ï¸ **LÆ°u Ã½:** Máº¥t dá»¯ liá»‡u khi server restart (cÃ³ thá»ƒ sync Firebase)

---

## ğŸ”§ PHáº¦N 2: BACKEND

### 2.1. Telemetry Service

#### `TelemetryService.js`
**File:** `ssb-backend/src/services/TelemetryService.js`

**Chá»©c nÄƒng chÃ­nh:**

1. **Rate Limiting (Äáº£m báº£o â‰¤ 3 giÃ¢y):**
   ```javascript
   // Line 84-106
   const RATE_LIMIT_MS = 2000; // 2 giÃ¢y
   
   function getRateLimitMs() {
     // CÃ³ thá»ƒ láº¥y tá»« SettingsService hoáº·c dÃ¹ng giÃ¡ trá»‹ máº·c Ä‘á»‹nh
     const settings = SettingsService.getSettings();
     if (settings.realtimeThrottleSeconds) {
       return settings.realtimeThrottleSeconds * 1000;
     }
     return RATE_LIMIT_MS; // 2000ms = 2 giÃ¢y
   }
   
   // Line 253-263
   const now = Date.now();
   const lastUpdate = lastUpdateTime.get(`bus-${busId}`);
   const rateLimitMs = getRateLimitMs();
   
   if (lastUpdate && now - lastUpdate < rateLimitMs) {
     const waitTime = Math.ceil((rateLimitMs - (now - lastUpdate)) / 1000);
     throw new Error(`Vui lÃ²ng Ä‘á»£i ${waitTime}s trÆ°á»›c khi gá»­i vá»‹ trÃ­ tiáº¿p theo`);
   }
   ```
   - âœ… **Rate limit: 2 giÃ¢y** - Äáº£m báº£o Ä‘á»™ trá»… â‰¤ 3 giÃ¢y (yÃªu cáº§u)
   - âœ… **CÃ³ thá»ƒ cáº¥u hÃ¬nh:** Láº¥y tá»« SettingsService
   - âœ… **TrÃ¡nh spam:** Chá»‰ cho phÃ©p cáº­p nháº­t má»—i 2 giÃ¢y

2. **In-Memory Cache:**
   ```javascript
   // Line 54-68
   const busPositions = new Map(); // LÆ°u vá»‹ trÃ­ xe
   const lastUpdateTime = new Map(); // LÆ°u thá»i gian cáº­p nháº­t cuá»‘i
   
   // Line 265-277
   const position = {
     lat, lng, speed: speed || 0, heading: heading || 0,
     timestamp: new Date().toISOString(), tripId, busId
   };
   busPositions.set(`bus-${busId}`, position);
   lastUpdateTime.set(`bus-${busId}`, now);
   ```
   - âœ… **O(1) lookup:** Map nhanh hÆ¡n Object
   - âœ… **Real-time:** KhÃ´ng cáº§n query database
   - âœ… **Timestamp:** LÆ°u thá»i gian cáº­p nháº­t

3. **Validation GPS:**
   ```javascript
   // Line 220-234
   if (!lat || !lng) {
     throw new Error("Latitude vÃ  Longitude lÃ  báº¯t buá»™c");
   }
   if (lat < -90 || lat > 90) {
     throw new Error("Latitude pháº£i náº±m trong khoáº£ng -90 Ä‘áº¿n 90");
   }
   if (lng < -180 || lng > 180) {
     throw new Error("Longitude pháº£i náº±m trong khoáº£ng -180 Ä‘áº¿n 180");
   }
   ```
   - âœ… **Validation Ä‘áº§y Ä‘á»§:** Kiá»ƒm tra lat/lng há»£p lá»‡

4. **Broadcast Real-time (Socket.IO):**
   ```javascript
   // Line 279-297
   const positionUpdate = {
     busId, tripId, lat, lng, speed: speed || 0,
     heading: heading || 0, timestamp: position.timestamp
   };
   
   // Emit to trip room (parents + admin subscribed)
   io.to(`trip-${tripId}`).emit("bus_position_update", positionUpdate);
   
   // Also emit to bus room
   io.to(`bus-${busId}`).emit("bus_position_update", positionUpdate);
   
   // Emit to role-admin for monitoring
   io.to("role-quan_tri").emit("bus_position_update", positionUpdate);
   ```
   - âœ… **Broadcast Ä‘áº¿n nhiá»u rooms:** Giáº£m latency
   - âœ… **Real-time:** Socket.IO WebSocket transport
   - âœ… **Multiple subscribers:** Trip room, bus room, admin room

5. **Firebase Sync (Optional):**
   ```javascript
   // Line 301-318
   try {
     await syncBusLocation(busId, {
       tripId, lat, lng, speed: speed || 0,
       heading: heading || 0, timestamp: position.timestamp
     });
   } catch (firebaseError) {
     // Don't fail the entire request if Firebase sync fails
     console.error("âš ï¸  Firebase sync failed (non-fatal):", firebaseError.message);
   }
   ```
   - âœ… **Firebase sync:** Cho phÃ©p FE Ä‘á»c vá»‹ trÃ­ khi WebSocket disconnect
   - âœ… **Non-fatal:** KhÃ´ng fail request náº¿u Firebase lá»—i

6. **Geofence & Delay Detection:**
   ```javascript
   // Line 320-341
   // Check geofence (xe gáº§n Ä‘iá»ƒm dá»«ng?)
   const approachEvent = await this.checkGeofence(tripId, { lat, lng }, io, schedule);
   if (approachEvent) {
     events.push("approach_stop");
   }
   
   // Check delay (xe bá»‹ trá»…?)
   const delayEvent = await this.checkDelay(tripId, { lat, lng }, io, schedule, trip);
   if (delayEvent) {
     events.push("delay_alert");
   }
   ```
   - âœ… **Tá»± Ä‘á»™ng phÃ¡t hiá»‡n:** Geofence vÃ  delay
   - âœ… **Emit events:** `approach_stop`, `delay_alert`

**ÄÃ¡nh giÃ¡ Service:**
- âœ… Rate limiting Ä‘áº£m báº£o â‰¤ 3 giÃ¢y
- âœ… In-memory cache hiá»‡u quáº£
- âœ… Broadcast real-time qua Socket.IO
- âœ… Validation vÃ  error handling Ä‘áº§y Ä‘á»§

---

### 2.2. WebSocket Handler

#### `ws/index.js`
**File:** `ssb-backend/src/ws/index.js`

**Chá»©c nÄƒng:**

1. **GPS Update Handler:**
   ```javascript
   // Line 147-209
   const handleGPSUpdate = async (data) => {
     const { tripId, lat, lng, speed, speedKph, heading, tsClient } = data;
     
     // Normalize field names (support both formats)
     const normalizedSpeed = speedKph || speed || 0;
     const normalizedHeading = heading || 0;
     
     // Verify driver owns this trip
     const trip = await ChuyenDiModel.getById(tripId);
     const schedule = await LichTrinhModel.getById(trip.maLichTrinh);
     
     // Only driver assigned to trip can send GPS
     if (user.vaiTro !== "tai_xe" || schedule.maTaiXe !== user.userId) {
       throw new Error("Only assigned driver can send GPS updates");
     }
     
     // Gá»i TelemetryService Ä‘á»ƒ xá»­ lÃ½
     const result = await TelemetryService.updatePosition(
       tripId,
       { lat, lng, speed: normalizedSpeed, heading: normalizedHeading },
       io
     );
     
     // Gá»­i ACK vá» driver
     socket.emit("gps_ack", {
       success: true,
       timestamp: result.position.timestamp,
       events: result.events
     });
   };
   
   // Support both event names
   socket.on("driver_gps", handleGPSUpdate); // Legacy
   socket.on("gps:update", handleGPSUpdate); // Standardized
   ```
   - âœ… **Há»— trá»£ 2 event names:** `driver_gps` (legacy) vÃ  `gps:update` (standardized)
   - âœ… **Authorization:** Chá»‰ tÃ i xáº¿ Ä‘Æ°á»£c phÃ¢n cÃ´ng má»›i cÃ³ thá»ƒ gá»­i GPS
   - âœ… **ACK response:** Gá»­i `gps_ack` vá» driver
   - âœ… **Error handling:** Catch vÃ  gá»­i error trong ACK

2. **Room Management:**
   ```javascript
   // Driver joins trip room when sending GPS
   socket.on("join_trip", (tripId) => {
     socket.join(`trip-${tripId}`);
   });
   
   // Parent/Admin joins trip room to receive updates
   socket.on("join_trip", (tripId) => {
     socket.join(`trip-${tripId}`);
   });
   ```
   - âœ… **Room-based broadcast:** Chá»‰ gá»­i Ä‘áº¿n clients trong room
   - âœ… **Giáº£m bandwidth:** KhÃ´ng broadcast Ä‘áº¿n táº¥t cáº£ clients

**ÄÃ¡nh giÃ¡ WebSocket Handler:**
- âœ… Authorization Ä‘Ãºng
- âœ… Error handling Ä‘áº§y Ä‘á»§
- âœ… ACK response cho driver
- âœ… Room-based broadcast hiá»‡u quáº£

---

### 2.3. REST API (Fallback)

#### `TelemetryController.js`
**File:** `ssb-backend/src/controllers/TelemetryController.js`

**API Endpoint:**

1. **`POST /api/trips/:id/telemetry`** - GPS update (HTTP fallback)
   ```javascript
   // Fallback khi WebSocket khÃ´ng available
   static async updatePosition(req, res) {
     const { id } = req.params;
     const { lat, lng, speed, heading } = req.body;
     
     const result = await TelemetryService.updatePosition(
       id,
       { lat, lng, speed, heading },
       io
     );
     
     return res.status(200).json({
       success: true,
       data: result
     });
   }
   ```
   - âœ… **HTTP fallback:** Khi WebSocket khÃ´ng available
   - âœ… **CÃ¹ng logic:** DÃ¹ng TelemetryService

**ÄÃ¡nh giÃ¡ REST API:**
- âœ… Fallback khi WebSocket fail
- âœ… CÃ¹ng validation vÃ  rate limiting

---

## ğŸ¨ PHáº¦N 3: FRONTEND

### 3.1. GPS Hook (Driver)

#### `use-gps.ts`
**File:** `ssb-frontend/hooks/use-gps.ts`

**Chá»©c nÄƒng:**

1. **Browser Geolocation:**
   ```typescript
   // Line 114-134
   watchIdRef.current = navigator.geolocation.watchPosition(
     (pos) => {
       const coords = pos.coords;
       const point: GpsPoint = {
         lat: coords.latitude,
         lng: coords.longitude,
         speed: typeof coords.speed === "number" ? coords.speed * 3.6 : undefined, // m/s -> km/h
         heading: typeof coords.heading === "number" ? coords.heading : undefined,
         timestamp: Date.now(),
       };
       setLastPoint(point);
       currentPositionRef.current = point; // LÆ°u vá»‹ trÃ­ má»›i nháº¥t
     },
     (err) => {
       console.warn("[useGPS] geolocation error", err);
     },
     { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 }
   );
   ```
   - âœ… **Browser API:** Sá»­ dá»¥ng `navigator.geolocation.watchPosition`
   - âœ… **High accuracy:** `enableHighAccuracy: true`
   - âœ… **Real-time:** `maximumAge: 0` (khÃ´ng dÃ¹ng cache)

2. **Send GPS má»—i 3 giÃ¢y:**
   ```typescript
   // Line 136-141
   // Gá»­i GPS má»—i 3 giÃ¢y
   sendIntervalRef.current = setInterval(() => {
     if (currentPositionRef.current) {
       send(currentPositionRef.current);
     }
   }, 3000);
   ```
   - âœ… **Interval: 3 giÃ¢y** - Äáº£m báº£o â‰¤ 3 giÃ¢y yÃªu cáº§u
   - âœ… **LÆ°u vá»‹ trÃ­ má»›i nháº¥t:** DÃ¹ng `currentPositionRef` Ä‘á»ƒ trÃ¡nh máº¥t vá»‹ trÃ­

3. **Send Function (Socket.IO + REST fallback):**
   ```typescript
   // Line 60-106
   async function send(point: GpsPoint) {
     if (!tripId) return;
     
     // Try socket first
     try {
       if (socketService.isConnected()) {
         socketService.sendDriverGPS({
           tripId,
           lat: point.lat,
           lng: point.lng,
           speed: point.speed,
           heading: point.heading,
         });
         return;
       }
     } catch {}
     
     // Fallback to REST
     await fetch(`${API_ORIGIN}/api/trips/${tripId}/telemetry`, {
       method: "POST",
       headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
       body: JSON.stringify({
         lat: point.lat,
         lng: point.lng,
         speed: point.speed,
         heading: point.heading,
       }),
     });
   }
   ```
   - âœ… **Socket.IO Æ°u tiÃªn:** Nhanh hÆ¡n REST
   - âœ… **REST fallback:** Khi WebSocket khÃ´ng available
   - âœ… **Error handling:** Try-catch Ä‘á»ƒ khÃ´ng crash

**ÄÃ¡nh giÃ¡ GPS Hook:**
- âœ… Gá»­i GPS má»—i 3 giÃ¢y (Ä‘áº£m báº£o â‰¤ 3 giÃ¢y)
- âœ… Socket.IO + REST fallback
- âœ… Browser geolocation vá»›i high accuracy

---

### 3.2. Socket Hook (Receive Updates)

#### `use-socket.ts`
**File:** `ssb-frontend/hooks/use-socket.ts`

**Chá»©c nÄƒng:**

1. **`useTripBusPosition(tripId)`** - Nháº­n vá»‹ trÃ­ xe theo trip
   ```typescript
   // Line 224-291
   export function useTripBusPosition(tripId?: number) {
     const [busPosition, setBusPosition] = useState<{...} | null>(null);
     const { isConnected } = useSocket();
     
     useEffect(() => {
       if (!tripId || !isConnected) return;
       
       const socket = socketService.getSocket();
       // Join trip room to receive updates
       socket?.emit('join_trip', tripId);
       
       const onData = (data: any) => {
         if (!data) return;
         const tId = data.tripId ?? data.trip_id;
         if ((tId + '') !== (tripId + '')) return;
         const lat = data.lat ?? data.latitude ?? data.coords?.lat;
         const lng = data.lng ?? data.longitude ?? data.coords?.lng;
         if (typeof lat !== 'number' || typeof lng !== 'number') return;
         setBusPosition({
           lat, lng,
           busId: data.busId ?? data.bus_id,
           speed: data.speed,
           heading: data.heading ?? data.direction,
           timestamp: data.timestamp,
         });
       };
       
       // Listen to socket events directly
       socket?.on('bus_position_update', onData);
       socket?.on('bus_location_update', onData);
       
       // Fallback to DOM CustomEvents
       window.addEventListener('busPositionUpdate', (event: Event) => {
         onData((event as CustomEvent).detail);
       });
       
       return () => {
         socket?.emit('leave_trip', tripId);
         socket?.off('bus_position_update', onData);
         window.removeEventListener('busPositionUpdate', ...);
       };
     }, [tripId, isConnected]);
     
     return { busPosition };
   }
   ```
   - âœ… **Join trip room:** Äá»ƒ nháº­n updates
   - âœ… **Listen events:** `bus_position_update`, `bus_location_update`
   - âœ… **DOM fallback:** CustomEvents náº¿u socket khÃ´ng available
   - âœ… **Cleanup:** Leave room vÃ  remove listeners

2. **`useTripAlerts(tripId)`** - Nháº­n alerts (approach_stop, delay_alert)
   ```typescript
   // Line 295-335
   export function useTripAlerts(tripId?: number) {
     const [approachStop, setApproachStop] = useState<any | null>(null);
     const [delayAlert, setDelayAlert] = useState<any | null>(null);
     
     useEffect(() => {
       if (!tripId || !isConnected) return;
       
       const socket = socketService.getSocket();
       
       socket?.on('approach_stop', (data: any) => {
         const tId = data?.tripId ?? data?.trip_id;
         if ((tId + "") !== (tripId + "")) return;
         setApproachStop(data);
       });
       
       socket?.on('delay_alert', (data: any) => {
         const tId = data?.tripId ?? data?.trip_id;
         if ((tId + "") !== (tripId + "")) return;
         setDelayAlert(data);
       });
       
       // DOM fallback
       window.addEventListener('approachStop', ...);
       window.addEventListener('delayAlert', ...);
       
       return () => {
         socket?.off('approach_stop', ...);
         socket?.off('delay_alert', ...);
         window.removeEventListener('approachStop', ...);
         window.removeEventListener('delayAlert', ...);
       };
     }, [tripId, isConnected]);
     
     return { approachStop, delayAlert };
   }
   ```
   - âœ… **Nháº­n alerts:** `approach_stop`, `delay_alert`
   - âœ… **Filter by tripId:** Chá»‰ nháº­n alerts cá»§a trip hiá»‡n táº¡i

**ÄÃ¡nh giÃ¡ Socket Hook:**
- âœ… Real-time updates qua Socket.IO
- âœ… Room-based subscription
- âœ… DOM fallback
- âœ… Cleanup Ä‘Ãºng cÃ¡ch

---

### 3.3. Tracking Pages

#### `/admin/tracking` - Admin Tracking Page
**File:** `ssb-frontend/app/admin/tracking/page.tsx`

**Chá»©c nÄƒng:**

1. **Load Active Trips:**
   ```typescript
   // Line 79-150
   const tripsRes = await apiClient.getTrips({ trangThai: 'dang_chay' });
   const trips: any[] = Array.isArray(tripsRes?.data) ? tripsRes.data : [];
   
   // Fetch detailed trip info for each trip to get route polyline
   const busesWithRoutes: Bus[] = [];
   for (const trip of trips) {
     const tripDetail = await apiClient.getTripById(trip.maChuyen || trip.id);
     // Process trip data...
   }
   ```
   - âœ… **Load active trips:** Láº¥y táº¥t cáº£ chuyáº¿n Ä‘ang cháº¡y
   - âœ… **Fetch details:** Láº¥y thÃ´ng tin tuyáº¿n, xe, tÃ i xáº¿

2. **Real-time Updates:**
   ```typescript
   // Listen to bus_position_update events
   useEffect(() => {
     const socket = socketService.getSocket();
     socket?.on('bus_position_update', (data: any) => {
       // Update bus position in state
       setBuses(prev => prev.map(bus => 
         bus.id === data.busId ? { ...bus, lat: data.lat, lng: data.lng } : bus
       ));
     });
     
     return () => {
       socket?.off('bus_position_update', ...);
     };
   }, []);
   ```
   - âœ… **Real-time updates:** Nháº­n `bus_position_update` events
   - âœ… **Update map:** Cáº­p nháº­t vá»‹ trÃ­ xe trÃªn báº£n Ä‘á»“

3. **Map Display:**
   ```typescript
   <MapView
     buses={buses}
     routes={routes}
     selectedBus={selectedBus}
     onBusSelect={setSelectedBus}
   />
   ```
   - âœ… **Map component:** Hiá»ƒn thá»‹ táº¥t cáº£ xe trÃªn báº£n Ä‘á»“
   - âœ… **Real-time:** Cáº­p nháº­t vá»‹ trÃ­ real-time

**ÄÃ¡nh giÃ¡ Admin Tracking:**
- âœ… Hiá»ƒn thá»‹ táº¥t cáº£ xe Ä‘ang cháº¡y
- âœ… Real-time updates
- âœ… Map visualization

---

#### `/parent/page.tsx` - Parent Tracking Page
**File:** `ssb-frontend/app/parent/page.tsx`

**Chá»©c nÄƒng:**

1. **Use Trip Bus Position Hook:**
   ```typescript
   // Line 25-50
   const { busPosition } = useTripBusPosition(selectedTripId);
   
   useEffect(() => {
     if (busPosition && Number.isFinite(busPosition.lat) && Number.isFinite(busPosition.lng)) {
       console.log('[Parent] busPosition', busPosition);
       setBusLocation({ lat: busPosition.lat, lng: busPosition.lng });
       setLastUpdate(Date.now());
     }
   }, [busPosition]);
   ```
   - âœ… **Hook integration:** DÃ¹ng `useTripBusPosition` Ä‘á»ƒ nháº­n vá»‹ trÃ­
   - âœ… **Update state:** Cáº­p nháº­t `busLocation` khi cÃ³ update

2. **Trip Alerts:**
   ```typescript
   // Line 29-73
   const { approachStop, delayAlert } = useTripAlerts(selectedTripId);
   
   useEffect(() => {
     if (approachStop) {
       toast({
         title: 'Xe sáº¯p Ä‘áº¿n Ä‘iá»ƒm dá»«ng',
         description: `Trip ${selectedTripId} sáº¯p Ä‘áº¿n Ä‘iá»ƒm ${approachStop.stopName}`
       });
     }
   }, [approachStop]);
   
   useEffect(() => {
     if (delayAlert) {
       toast({
         title: 'Cáº£nh bÃ¡o trá»… chuyáº¿n',
         description: delayAlert.reason || 'Xe cÃ³ thá»ƒ Ä‘áº¿n trá»…',
         variant: 'destructive',
       });
     }
   }, [delayAlert]);
   ```
   - âœ… **Alerts:** Hiá»ƒn thá»‹ `approach_stop` vÃ  `delay_alert`
   - âœ… **Toast notifications:** ThÃ´ng bÃ¡o cho phá»¥ huynh

3. **Map Display:**
   ```typescript
   <MapView
     busLocation={busLocation}
     stops={stops}
     routePolyline={routePolyline}
   />
   ```
   - âœ… **Map component:** Hiá»ƒn thá»‹ vá»‹ trÃ­ xe cá»§a con
   - âœ… **Real-time:** Cáº­p nháº­t vá»‹ trÃ­ real-time

**ÄÃ¡nh giÃ¡ Parent Tracking:**
- âœ… Hiá»ƒn thá»‹ vá»‹ trÃ­ xe cá»§a con
- âœ… Real-time updates
- âœ… Alerts (approach_stop, delay_alert)

---

### 3.4. Socket Service

#### `socket.ts`
**File:** `ssb-frontend/lib/socket.ts`

**Chá»©c nÄƒng:**

1. **Send Driver GPS:**
   ```typescript
   // Line 77-79
   sendDriverGPS(data: { tripId: number | string; lat: number; lng: number; speed?: number; heading?: number }) {
     this.socket?.emit('driver_gps', data)
   }
   ```
   - âœ… **Emit event:** Gá»­i GPS qua Socket.IO
   - âœ… **Event name:** `driver_gps` (legacy, cÅ©ng há»— trá»£ `gps:update`)

2. **Listen Bus Position Update:**
   ```typescript
   // Line 140-143
   this.socket.on("bus_position_update", (data) => {
     console.log("Bus position updated:", data);
     window.dispatchEvent(new CustomEvent("busPositionUpdate", { detail: data }));
   });
   ```
   - âœ… **Listen event:** Nháº­n `bus_position_update`
   - âœ… **DOM bridge:** Dispatch CustomEvent Ä‘á»ƒ components khÃ¡c listen

**ÄÃ¡nh giÃ¡ Socket Service:**
- âœ… Send vÃ  receive GPS updates
- âœ… DOM bridge cho components
- âœ… Error handling

---

## ğŸ“Š Tá»”NG Káº¾T VÃ€ ÄÃNH GIÃ

### âœ… Äiá»ƒm máº¡nh

1. **Rate Limiting:**
   - âœ… **2 giÃ¢y** - Äáº£m báº£o â‰¤ 3 giÃ¢y yÃªu cáº§u
   - âœ… **CÃ³ thá»ƒ cáº¥u hÃ¬nh** - Láº¥y tá»« SettingsService
   - âœ… **TrÃ¡nh spam** - Chá»‰ cho phÃ©p cáº­p nháº­t má»—i 2 giÃ¢y

2. **Real-time Communication:**
   - âœ… **Socket.IO** - WebSocket transport nhanh
   - âœ… **Room-based broadcast** - Giáº£m bandwidth
   - âœ… **Multiple rooms** - Trip, bus, admin rooms

3. **In-Memory Cache:**
   - âœ… **O(1) lookup** - Map nhanh hÆ¡n Object
   - âœ… **Real-time** - KhÃ´ng cáº§n query database
   - âœ… **Timestamp** - LÆ°u thá»i gian cáº­p nháº­t

4. **Frontend:**
   - âœ… **Gá»­i GPS má»—i 3 giÃ¢y** - Äáº£m báº£o â‰¤ 3 giÃ¢y
   - âœ… **Socket.IO + REST fallback** - Reliability
   - âœ… **Real-time updates** - Nháº­n updates ngay láº­p tá»©c

5. **Validation & Error Handling:**
   - âœ… **GPS validation** - Kiá»ƒm tra lat/lng há»£p lá»‡
   - âœ… **Authorization** - Chá»‰ tÃ i xáº¿ Ä‘Æ°á»£c phÃ¢n cÃ´ng má»›i gá»­i GPS
   - âœ… **Error handling** - Try-catch vÃ  ACK responses

### âš ï¸ Äiá»ƒm cáº§n cáº£i thiá»‡n

1. **Persistence:**
   - âš ï¸ Vá»‹ trÃ­ GPS chá»‰ lÆ°u trong memory, máº¥t khi server restart
   - ğŸ’¡ **Äá» xuáº¥t:** Sync sang Firebase Realtime Database (Ä‘Ã£ cÃ³ code nhÆ°ng optional)

2. **Load Testing:**
   - âš ï¸ ChÆ°a cÃ³ load test cho 300 xe Ä‘á»“ng thá»i
   - ğŸ’¡ **Äá» xuáº¥t:** Táº¡o script load test Ä‘á»ƒ verify performance

3. **GPS History:**
   - âš ï¸ ChÆ°a lÆ°u lá»‹ch sá»­ vá»‹ trÃ­ GPS (chá»‰ real-time)
   - ğŸ’¡ **Äá» xuáº¥t:** LÆ°u vÃ o database vá»›i sampling (má»—i 30 giÃ¢y) náº¿u cáº§n

### âœ… Káº¿t luáº­n

**Tráº¡ng thÃ¡i:** âœ… **HOÃ€N THÃ€NH Äáº¦Y Äá»¦**

Há»‡ thá»‘ng Ä‘Ã£ triá»ƒn khai Ä‘áº§y Ä‘á»§ chá»©c nÄƒng **"Cáº­p nháº­t vá»‹ trÃ­ cá»§a cÃ¡c xe buÃ½t theo thá»i gian thá»±c (tá»‘i Ä‘a Ä‘á»™ trá»… 3 giÃ¢y)"** vá»›i:
- âœ… **Rate limiting:** 2 giÃ¢y (Ä‘áº£m báº£o â‰¤ 3 giÃ¢y yÃªu cáº§u)
- âœ… **In-memory cache:** Map lÆ°u vá»‹ trÃ­ real-time
- âœ… **Socket.IO:** Broadcast real-time Ä‘áº¿n nhiá»u rooms
- âœ… **Frontend:** Gá»­i GPS má»—i 3 giÃ¢y, nháº­n updates real-time
- âœ… **Validation:** Kiá»ƒm tra lat/lng há»£p lá»‡
- âœ… **Geofence & Delay:** Tá»± Ä‘á»™ng phÃ¡t hiá»‡n vÃ  emit events

**YÃªu cáº§u Ä‘Ã¡p á»©ng:**
- âœ… Cáº­p nháº­t vá»‹ trÃ­ theo thá»i gian thá»±c
- âœ… Tá»‘i Ä‘a Ä‘á»™ trá»… 3 giÃ¢y (rate limit 2 giÃ¢y)
- âœ… Broadcast Ä‘áº¿n nhiá»u clients (parents, admin)
- âœ… Validation vÃ  error handling

**Khuyáº¿n nghá»‹:**
- ğŸ’¡ Load test cho 300 xe Ä‘á»“ng thá»i
- ğŸ’¡ Sync GPS sang Firebase (optional, Ä‘Ã£ cÃ³ code)
- ğŸ’¡ LÆ°u GPS history náº¿u cáº§n (vá»›i sampling)

---

**NgÆ°á»i kiá»ƒm tra:** AI Assistant  
**NgÃ y hoÃ n thÃ nh:** 2025-11-12

