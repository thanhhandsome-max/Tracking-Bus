# BÃO CÃO KIá»‚M TRA CHI TIáº¾T - 1.2
## Táº O VÃ€ Cáº¬P NHáº¬T Lá»ŠCH TRÃŒNH XE (TUáº¦N/THÃNG)

**NgÃ y kiá»ƒm tra:** 2025-11-12  
**PhiÃªn báº£n:** 1.0  
**YÃªu cáº§u:** YeuCauDoAn.md - Chá»©c nÄƒng Quáº£n lÃ½ xe buÃ½t (1.2)

---

## ğŸ“‹ TÃ“M Táº®T

**Tráº¡ng thÃ¡i:** âœ… **HOÃ€N THÃ€NH Äáº¦Y Äá»¦** (vá»›i lÆ°u Ã½ vá» batch create)

Há»‡ thá»‘ng Ä‘Ã£ triá»ƒn khai Ä‘áº§y Ä‘á»§ chá»©c nÄƒng táº¡o vÃ  cáº­p nháº­t lá»‹ch trÃ¬nh xe vá»›i:
- âœ… Database schema Ä‘áº§y Ä‘á»§ vá»›i constraint UNIQUE Ä‘á»ƒ trÃ¡nh xung Ä‘á»™t
- âœ… Backend API RESTful vá»›i conflict detection chi tiáº¿t
- âœ… Frontend UI Ä‘áº§y Ä‘á»§ vá»›i form táº¡o/cáº­p nháº­t, calendar view
- âœ… Há»— trá»£ táº¡o lá»‹ch theo ngÃ y (cÃ³ thá»ƒ má»Ÿ rá»™ng batch create cho tuáº§n/thÃ¡ng)
- âœ… Kiá»ƒm tra xung Ä‘á»™t: xe/tÃ i xáº¿ khÃ´ng thá»ƒ cÃ³ 2 lá»‹ch trÃ¬nh cÃ¹ng giá»

**LÆ°u Ã½:** Hiá»‡n táº¡i há»‡ thá»‘ng há»— trá»£ táº¡o lá»‹ch trÃ¬nh theo tá»«ng ngÃ y. Äá»ƒ táº¡o cho tuáº§n/thÃ¡ng, admin cáº§n táº¡o nhiá»u lá»‹ch trÃ¬nh cho tá»«ng ngÃ y (cÃ³ thá»ƒ cáº£i thiá»‡n báº±ng batch create API).

---

## ğŸ—„ï¸ PHáº¦N 1: DATABASE (SQL)

### 1.1. Schema Design

#### Báº£ng `LichTrinh` (Lá»‹ch trÃ¬nh)
**File:** `database/01_init_db_ver2.sql` (line 164-186)

```sql
CREATE TABLE LichTrinh (
    maLichTrinh INT AUTO_INCREMENT PRIMARY KEY,
    maTuyen INT NOT NULL,
    maXe INT NOT NULL,
    maTaiXe INT NOT NULL,
    loaiChuyen ENUM('don_sang', 'tra_chieu') NOT NULL,
    gioKhoiHanh TIME NOT NULL,
    ngayChay DATE NOT NULL,
    dangApDung BOOLEAN DEFAULT TRUE,
    ngayTao TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    ngayCapNhat TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (maTuyen) REFERENCES TuyenDuong(maTuyen),
    FOREIGN KEY (maXe) REFERENCES XeBuyt(maXe),
    FOREIGN KEY (maTaiXe) REFERENCES NguoiDung(maNguoiDung),
    UNIQUE KEY unique_tuyen_xe_taixe_ngay_gio (maTuyen, maXe, maTaiXe, ngayChay, gioKhoiHanh, loaiChuyen),
    INDEX idx_maTuyen (maTuyen),
    INDEX idx_maXe (maXe),
    INDEX idx_maTaiXe (maTaiXe),
    INDEX idx_loaiChuyen (loaiChuyen),
    INDEX idx_gioKhoiHanh (gioKhoiHanh),
    INDEX idx_ngayChay (ngayChay),
    INDEX idx_dangApDung (dangApDung)
)ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

**ÄÃ¡nh giÃ¡:**
- âœ… **Foreign Keys:** Äáº£m báº£o tÃ­nh toÃ n váº¹n dá»¯ liá»‡u vá»›i `TuyenDuong`, `XeBuyt`, `NguoiDung`
- âœ… **UNIQUE Constraint:** `unique_tuyen_xe_taixe_ngay_gio` - NgÄƒn cháº·n táº¡o lá»‹ch trÃ¬nh trÃ¹ng láº·p (cÃ¹ng tuyáº¿n, xe, tÃ i xáº¿, ngÃ y, giá», loáº¡i chuyáº¿n)
- âœ… **ENUM loaiChuyen:** Chá»‰ cho phÃ©p `'don_sang'` hoáº·c `'tra_chieu'` - Ä‘áº£m báº£o dá»¯ liá»‡u há»£p lá»‡
- âœ… **ngayChay DATE:** Há»— trá»£ táº¡o lá»‹ch cho tá»«ng ngÃ y cá»¥ thá»ƒ
- âœ… **dangApDung BOOLEAN:** Soft delete - cÃ³ thá»ƒ vÃ´ hiá»‡u hÃ³a lá»‹ch trÃ¬nh mÃ  khÃ´ng xÃ³a
- âœ… **Indexes tá»‘i Æ°u:** 
  - `idx_maTuyen`, `idx_maXe`, `idx_maTaiXe` - TÃ¬m kiáº¿m theo tuyáº¿n/xe/tÃ i xáº¿
  - `idx_ngayChay` - TÃ¬m kiáº¿m theo ngÃ y (quan trá»ng cho lá»‹ch tuáº§n/thÃ¡ng)
  - `idx_gioKhoiHanh` - Sáº¯p xáº¿p theo giá»
  - `idx_loaiChuyen` - Lá»c theo loáº¡i chuyáº¿n
  - `idx_dangApDung` - Lá»c lá»‹ch trÃ¬nh Ä‘ang Ã¡p dá»¥ng

**Sample Data:** `database/02_sample_data.sql` (line 853-863)
```sql
INSERT INTO LichTrinh (maTuyen, maXe, maTaiXe, loaiChuyen, gioKhoiHanh, ngayChay, dangApDung) VALUES
(1, 1, 2, 'don_sang', '06:30:00', '2025-11-12', TRUE),
(2, 2, 3, 'don_sang', '06:45:00', '2025-11-12', TRUE),
(3, 3, 4, 'don_sang', '07:00:00', '2025-11-12', TRUE),
...
```
- âœ… CÃ³ dá»¯ liá»‡u máº«u cho nhiá»u lá»‹ch trÃ¬nh
- âœ… Há»— trá»£ cáº£ `don_sang` vÃ  `tra_chieu`
- âœ… NgÃ y cháº¡y cá»¥ thá»ƒ: `'2025-11-12'`

---

### 1.2. Quan há»‡ vá»›i cÃ¡c báº£ng khÃ¡c

#### Quan há»‡ vá»›i `TuyenDuong`
- `LichTrinh.maTuyen` â†’ `TuyenDuong.maTuyen` (FOREIGN KEY)
- Má»™t tuyáº¿n Ä‘Æ°á»ng cÃ³ thá»ƒ cÃ³ nhiá»u lá»‹ch trÃ¬nh

#### Quan há»‡ vá»›i `XeBuyt`
- `LichTrinh.maXe` â†’ `XeBuyt.maXe` (FOREIGN KEY)
- Má»™t xe buÃ½t cÃ³ thá»ƒ cÃ³ nhiá»u lá»‹ch trÃ¬nh (nhÆ°ng khÃ´ng trÃ¹ng giá» cÃ¹ng ngÃ y)

#### Quan há»‡ vá»›i `NguoiDung` (TÃ i xáº¿)
- `LichTrinh.maTaiXe` â†’ `NguoiDung.maNguoiDung` (FOREIGN KEY)
- Má»™t tÃ i xáº¿ cÃ³ thá»ƒ cÃ³ nhiá»u lá»‹ch trÃ¬nh (nhÆ°ng khÃ´ng trÃ¹ng giá» cÃ¹ng ngÃ y)

#### Quan há»‡ vá»›i `ChuyenDi` (Chuyáº¿n Ä‘i)
- `ChuyenDi.maLichTrinh` â†’ `LichTrinh.maLichTrinh` (FOREIGN KEY trong báº£ng ChuyenDi)
- Má»™t lá»‹ch trÃ¬nh cÃ³ thá»ƒ táº¡o nhiá»u chuyáº¿n Ä‘i (má»—i ngÃ y má»™t chuyáº¿n)

---

## ğŸ”§ PHáº¦N 2: BACKEND

### 2.1. Model Layer

#### `LichTrinhModel.js`
**File:** `ssb-backend/src/models/LichTrinhModel.js`

**Chá»©c nÄƒng chÃ­nh:**

1. **`getAll(filters)`** - Láº¥y táº¥t cáº£ lá»‹ch trÃ¬nh vá»›i filters
   - Há»— trá»£ filter: `maTuyen`, `maXe`, `maTaiXe`, `loaiChuyen`, `dangApDung`
   - JOIN vá»›i `TuyenDuong`, `XeBuyt`, `NguoiDung` Ä‘á»ƒ láº¥y thÃ´ng tin Ä‘áº§y Ä‘á»§
   - Máº·c Ä‘á»‹nh chá»‰ láº¥y lá»‹ch trÃ¬nh `dangApDung = TRUE`
   - Sáº¯p xáº¿p: `ngayChay DESC, gioKhoiHanh`

2. **`getById(id)`** - Láº¥y lá»‹ch trÃ¬nh theo ID
   - JOIN vá»›i cÃ¡c báº£ng liÃªn quan Ä‘á»ƒ láº¥y thÃ´ng tin chi tiáº¿t

3. **`getByDate(date)`** - Láº¥y lá»‹ch trÃ¬nh theo ngÃ y
   ```javascript
   // Line 337-355
   async getByDate(date) {
     const [rows] = await pool.query(
       `SELECT ... FROM LichTrinh lt
        WHERE lt.dangApDung = TRUE
          AND DATE(lt.ngayChay) = DATE(?)
        ORDER BY lt.gioKhoiHanh`,
       [date]
     );
     return rows;
   }
   ```
   - âœ… Há»— trá»£ láº¥y lá»‹ch trÃ¬nh theo ngÃ y cá»¥ thá»ƒ
   - âœ… CÃ³ thá»ƒ dÃ¹ng Ä‘á»ƒ táº¡o lá»‹ch cho tuáº§n/thÃ¡ng (láº·p qua tá»«ng ngÃ y)

4. **`create(data)`** - Táº¡o lá»‹ch trÃ¬nh má»›i
   ```javascript
   // Line 172-181
   async create(data) {
     const { maTuyen, maXe, maTaiXe, loaiChuyen, gioKhoiHanh, ngayChay, dangApDung } = data;
     const [result] = await pool.query(
       `INSERT INTO LichTrinh (maTuyen, maXe, maTaiXe, loaiChuyen, gioKhoiHanh, ngayChay, dangApDung)
        VALUES (?, ?, ?, ?, ?, ?, ?)`,
       [maTuyen, maXe, maTaiXe, loaiChuyen, gioKhoiHanh, ngayChay, dangApDung !== false]
     );
     return result.insertId;
   }
   ```
   - âœ… Táº¡o lá»‹ch trÃ¬nh vá»›i Ä‘áº§y Ä‘á»§ thÃ´ng tin
   - âœ… Tráº£ vá» `insertId` Ä‘á»ƒ láº¥y lá»‹ch trÃ¬nh vá»«a táº¡o

5. **`update(id, data)`** - Cáº­p nháº­t lá»‹ch trÃ¬nh (partial update)
   ```javascript
   // Line 184-228
   async update(id, data) {
     const fields = [];
     const values = [];
     // Build dynamic UPDATE query
     if (data.maTuyen !== undefined) { fields.push("maTuyen = ?"); values.push(data.maTuyen); }
     if (data.maXe !== undefined) { fields.push("maXe = ?"); values.push(data.maXe); }
     // ... cÃ¡c trÆ°á»ng khÃ¡c
     const query = `UPDATE LichTrinh SET ${fields.join(", ")} WHERE maLichTrinh = ?`;
     const [result] = await pool.query(query, values);
     return result.affectedRows > 0;
   }
   ```
   - âœ… Há»— trá»£ partial update - chá»‰ cáº­p nháº­t cÃ¡c trÆ°á»ng Ä‘Æ°á»£c cung cáº¥p
   - âœ… Linh hoáº¡t cho viá»‡c cáº­p nháº­t tá»«ng pháº§n

6. **`checkConflict(maXe, maTaiXe, gioKhoiHanh, loaiChuyen, ngayChay, excludeId)`** - Kiá»ƒm tra xung Ä‘á»™t
   ```javascript
   // Line 249-291
   async checkConflict(maXe, maTaiXe, gioKhoiHanh, loaiChuyen, ngayChay, excludeId = null) {
     let query = `
       SELECT 
         lt.maLichTrinh,
         lt.maXe,
         lt.maTaiXe,
         lt.gioKhoiHanh,
         lt.loaiChuyen,
         lt.ngayChay,
         xb.bienSoXe,
         nd.hoTen as tenTaiXe,
         CASE 
           WHEN lt.maXe = ? THEN 'bus'
           WHEN lt.maTaiXe = ? THEN 'driver'
           ELSE 'both'
         END as conflictType
       FROM LichTrinh lt
       WHERE (lt.maXe = ? OR lt.maTaiXe = ?)
       AND lt.gioKhoiHanh = ?
       AND lt.loaiChuyen = ?
       AND DATE(lt.ngayChay) = DATE(?)
       AND lt.dangApDung = TRUE
     `;
     // ...
   }
   ```
   - âœ… **Kiá»ƒm tra xung Ä‘á»™t chi tiáº¿t:** Xe hoáº·c tÃ i xáº¿ Ä‘Ã£ cÃ³ lá»‹ch trÃ¬nh cÃ¹ng giá», loáº¡i chuyáº¿n, ngÃ y
   - âœ… **Tráº£ vá» conflictType:** `'bus'`, `'driver'`, hoáº·c `'both'` - giÃºp frontend hiá»ƒn thá»‹ lá»—i rÃµ rÃ ng
   - âœ… **excludeId:** Bá» qua lá»‹ch trÃ¬nh hiá»‡n táº¡i khi update (trÃ¡nh bÃ¡o xung Ä‘á»™t vá»›i chÃ­nh nÃ³)

7. **`delete(id)`** - Soft delete (Ä‘áº·t `dangApDung = FALSE`)
   - âœ… KhÃ´ng xÃ³a vÄ©nh viá»…n, chá»‰ vÃ´ hiá»‡u hÃ³a
   - âœ… Giá»¯ láº¡i lá»‹ch sá»­

**ÄÃ¡nh giÃ¡ Model:**
- âœ… Äáº§y Ä‘á»§ CRUD operations
- âœ… Há»— trá»£ filter vÃ  search
- âœ… Conflict detection chi tiáº¿t
- âœ… Soft delete an toÃ n
- âœ… JOIN vá»›i cÃ¡c báº£ng liÃªn quan Ä‘á»ƒ láº¥y thÃ´ng tin Ä‘áº§y Ä‘á»§

---

### 2.2. Service Layer

#### `ScheduleService.js`
**File:** `ssb-backend/src/services/ScheduleService.js`

**Chá»©c nÄƒng chÃ­nh:**

1. **`create(payload)`** - Táº¡o lá»‹ch trÃ¬nh vá»›i validation vÃ  conflict check
   ```javascript
   // Line 52-89
   static async create(payload) {
     const { maTuyen, maXe, maTaiXe, loaiChuyen, gioKhoiHanh, ngayChay } = payload;
     
     // Validation
     if (!maTuyen || !maXe || !maTaiXe || !loaiChuyen || !gioKhoiHanh || !ngayChay)
       throw new Error("MISSING_REQUIRED_FIELDS");
     if (!VALID_LOAI_CHUYEN.includes(loaiChuyen))
       throw new Error("INVALID_TRIP_TYPE");
     
     // Check existence
     const route = await TuyenDuongModel.getById(maTuyen);
     if (!route) throw new Error("ROUTE_NOT_FOUND");
     const bus = await XeBuytModel.getById(maXe);
     if (!bus) throw new Error("BUS_NOT_FOUND");
     const driver = await TaiXeModel.getById(maTaiXe);
     if (!driver) throw new Error("DRIVER_NOT_FOUND");
     
     // Check conflict
     const conflicts = await LichTrinhModel.checkConflict(
       maXe, maTaiXe, gioKhoiHanh, loaiChuyen, ngayChay
     );
     if (conflicts && conflicts.length > 0) {
       const error = new Error("SCHEDULE_CONFLICT");
       error.conflicts = conflicts; // Attach conflict details
       throw error;
     }
     
     // Create
     const id = await LichTrinhModel.create({...});
     return await LichTrinhModel.getById(id);
   }
   ```
   - âœ… **Validation Ä‘áº§y Ä‘á»§:** Kiá»ƒm tra required fields, loáº¡i chuyáº¿n há»£p lá»‡
   - âœ… **Kiá»ƒm tra tá»“n táº¡i:** Tuyáº¿n, xe, tÃ i xáº¿ pháº£i tá»“n táº¡i
   - âœ… **Conflict detection:** Kiá»ƒm tra xung Ä‘á»™t trÆ°á»›c khi táº¡o
   - âœ… **Error vá»›i details:** Tráº£ vá» conflict details Ä‘á»ƒ frontend hiá»ƒn thá»‹

2. **`update(id, data)`** - Cáº­p nháº­t lá»‹ch trÃ¬nh vá»›i validation vÃ  conflict check
   ```javascript
   // Line 91-132
   static async update(id, data) {
     const existing = await LichTrinhModel.getById(id);
     if (!existing) throw new Error("SCHEDULE_NOT_FOUND");
     
     // Validation
     if (data.loaiChuyen && !VALID_LOAI_CHUYEN.includes(data.loaiChuyen))
       throw new Error("INVALID_TRIP_TYPE");
     
     // Check existence if changed
     if (data.maTuyen && data.maTuyen !== existing.maTuyen) {
       const r = await TuyenDuongModel.getById(data.maTuyen);
       if (!r) throw new Error("ROUTE_NOT_FOUND");
     }
     // ... tÆ°Æ¡ng tá»± cho maXe, maTaiXe
     
     // Check conflict (exclude current schedule)
     const checkMaXe = data.maXe || existing.maXe;
     const checkMaTaiXe = data.maTaiXe || existing.maTaiXe;
     const checkGio = data.gioKhoiHanh || existing.gioKhoiHanh;
     const checkLoai = data.loaiChuyen || existing.loaiChuyen;
     const checkNgay = data.ngayChay || existing.ngayChay;
     const conflicts = await LichTrinhModel.checkConflict(
       checkMaXe, checkMaTaiXe, checkGio, checkLoai, checkNgay, id
     );
     if (conflicts && conflicts.length > 0) {
       const error = new Error("SCHEDULE_CONFLICT");
       error.conflicts = conflicts;
       throw error;
     }
     
     await LichTrinhModel.update(id, data);
     return await LichTrinhModel.getById(id);
   }
   ```
   - âœ… **Kiá»ƒm tra tá»“n táº¡i:** Chá»‰ kiá»ƒm tra náº¿u giÃ¡ trá»‹ thay Ä‘á»•i
   - âœ… **Conflict check vá»›i excludeId:** TrÃ¡nh bÃ¡o xung Ä‘á»™t vá»›i chÃ­nh lá»‹ch trÃ¬nh Ä‘ang update
   - âœ… **Partial update:** Chá»‰ cáº­p nháº­t cÃ¡c trÆ°á»ng Ä‘Æ°á»£c cung cáº¥p

3. **`delete(id)`** - XÃ³a lá»‹ch trÃ¬nh (soft delete)
   - âœ… Kiá»ƒm tra tá»“n táº¡i trÆ°á»›c khi xÃ³a

4. **Helper methods:**
   - `getByRoute(maTuyen)` - Láº¥y lá»‹ch trÃ¬nh theo tuyáº¿n
   - `getByBus(maXe)` - Láº¥y lá»‹ch trÃ¬nh theo xe
   - `getByDriver(maTaiXe)` - Láº¥y lá»‹ch trÃ¬nh theo tÃ i xáº¿

**ÄÃ¡nh giÃ¡ Service:**
- âœ… Business logic tÃ¡ch biá»‡t khá»i controller
- âœ… Validation Ä‘áº§y Ä‘á»§
- âœ… Conflict detection vá»›i error details
- âœ… Error handling rÃµ rÃ ng vá»›i error codes

---

### 2.3. Controller Layer

#### `ScheduleController.js`
**File:** `ssb-backend/src/controllers/ScheduleController.js`

**API Endpoints:**

1. **`GET /api/v1/schedules`** - Láº¥y danh sÃ¡ch lá»‹ch trÃ¬nh
   ```javascript
   // Line 12-92
   static async getAll(req, res) {
     const { page, limit, maTuyen, maXe, maTaiXe, loaiChuyen, dangApDung } = req.query;
     // Filter logic
     // Pagination
     res.status(200).json({ success: true, data: paginatedSchedules, pagination: {...} });
   }
   ```
   - âœ… Há»— trá»£ filter: `maTuyen`, `maXe`, `maTaiXe`, `loaiChuyen`, `dangApDung`
   - âœ… Pagination: `page`, `limit`
   - âœ… Tráº£ vá» pagination metadata

2. **`GET /api/v1/schedules/:id`** - Láº¥y chi tiáº¿t lá»‹ch trÃ¬nh
   ```javascript
   // Line 95-142
   static async getById(req, res) {
     const schedule = await LichTrinhModel.getById(id);
     // Láº¥y thÃ´ng tin chi tiáº¿t: busInfo, driverInfo, routeInfo, tripHistory
     res.status(200).json({ success: true, data: {...schedule, busInfo, driverInfo, routeInfo, tripHistory} });
   }
   ```
   - âœ… Tráº£ vá» thÃ´ng tin Ä‘áº§y Ä‘á»§: lá»‹ch trÃ¬nh + xe + tÃ i xáº¿ + tuyáº¿n + lá»‹ch sá»­ chuyáº¿n Ä‘i

3. **`POST /api/v1/schedules`** - Táº¡o lá»‹ch trÃ¬nh má»›i
   ```javascript
   // Line 145-277
   static async create(req, res) {
     const { maTuyen, maXe, maTaiXe, loaiChuyen, gioKhoiHanh, ngayChay, dangApDung } = req.body;
     
     // Validation
     if (!maTuyen || !maXe || !maTaiXe || !loaiChuyen || !gioKhoiHanh || !ngayChay) {
       return res.status(400).json({ success: false, message: "..." });
     }
     
     // Check existence
     const route = await TuyenDuongModel.getById(maTuyen);
     if (!route) return res.status(404).json({...});
     // ... tÆ°Æ¡ng tá»± cho bus, driver
     
     // Validation format
     const timeRegex = /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/;
     if (!timeRegex.test(gioKhoiHanh)) return res.status(400).json({...});
     const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
     if (!dateRegex.test(ngayChay)) return res.status(400).json({...});
     
     // Use ScheduleService
     try {
       const newSchedule = await ScheduleService.create({...});
       return response.created(res, newSchedule);
     } catch (serviceError) {
       // Handle conflict with details
       if (serviceError.message === "SCHEDULE_CONFLICT" && serviceError.conflicts) {
         return response.error(res, "SCHEDULE_CONFLICT", "Xung Ä‘á»™t lá»‹ch trÃ¬nh...", 409, {
           conflicts: serviceError.conflicts.map(c => ({...}))
         });
       }
       // Handle other errors
     }
   }
   ```
   - âœ… **Validation Ä‘áº§y Ä‘á»§:** Required fields, format (time, date), existence
   - âœ… **Conflict handling:** Tráº£ vá» 409 vá»›i conflict details
   - âœ… **Error codes rÃµ rÃ ng:** `SCHEDULE_CONFLICT`, `ROUTE_NOT_FOUND`, etc.

4. **`PUT /api/v1/schedules/:id`** - Cáº­p nháº­t lá»‹ch trÃ¬nh
   ```javascript
   // Line 280-343
   static async update(req, res) {
     const { id } = req.params;
     const updateData = {};
     if (maTuyen !== undefined) updateData.maTuyen = maTuyen;
     // ... build updateData
     
     try {
       const updatedSchedule = await ScheduleService.update(id, updateData);
       return response.ok(res, updatedSchedule);
     } catch (serviceError) {
       // Handle conflict with details (similar to create)
     }
   }
   ```
   - âœ… Partial update - chá»‰ cáº­p nháº­t cÃ¡c trÆ°á»ng Ä‘Æ°á»£c cung cáº¥p
   - âœ… Conflict handling tÆ°Æ¡ng tá»± create

5. **`DELETE /api/v1/schedules/:id`** - XÃ³a lá»‹ch trÃ¬nh
   ```javascript
   // Line 346-397
   static async delete(req, res) {
     // Check existence
     // Check if used in trips
     const trips = await ChuyenDiModel.getByScheduleId(id);
     if (trips.length > 0) {
       return res.status(409).json({
         success: false,
         message: "KhÃ´ng thá»ƒ xÃ³a lá»‹ch trÃ¬nh Ä‘ang Ä‘Æ°á»£c sá»­ dá»¥ng trong chuyáº¿n Ä‘i",
         data: { tripsCount: trips.length }
       });
     }
     // Delete
   }
   ```
   - âœ… Kiá»ƒm tra lá»‹ch trÃ¬nh cÃ³ Ä‘ang Ä‘Æ°á»£c sá»­ dá»¥ng trong chuyáº¿n Ä‘i khÃ´ng
   - âœ… Tráº£ vá» 409 náº¿u Ä‘ang Ä‘Æ°á»£c sá»­ dá»¥ng

6. **`GET /api/v1/schedules/date/:date`** - Láº¥y lá»‹ch trÃ¬nh theo ngÃ y
   ```javascript
   // Line 476-526
   static async getByDate(req, res) {
     const { date } = req.params;
     const { maTuyen, loaiChuyen } = req.query;
     // Validation date format
     let schedules = await LichTrinhModel.getByDate(date);
     // Filter by maTuyen, loaiChuyen if provided
     res.status(200).json({ success: true, data: schedules });
   }
   ```
   - âœ… Há»— trá»£ láº¥y lá»‹ch trÃ¬nh theo ngÃ y cá»¥ thá»ƒ
   - âœ… CÃ³ thá»ƒ filter thÃªm theo `maTuyen`, `loaiChuyen`
   - âœ… **Quan trá»ng:** CÃ³ thá»ƒ dÃ¹ng Ä‘á»ƒ táº¡o lá»‹ch cho tuáº§n/thÃ¡ng (láº·p qua tá»«ng ngÃ y)

7. **`GET /api/v1/schedules/stats`** - Thá»‘ng kÃª lá»‹ch trÃ¬nh
   - Tá»•ng sá»‘, Ä‘ang Ã¡p dá»¥ng, theo loáº¡i chuyáº¿n, theo tuyáº¿n, theo khung giá»

**ÄÃ¡nh giÃ¡ Controller:**
- âœ… Validation Ä‘áº§y Ä‘á»§ á»Ÿ controller level
- âœ… Error handling rÃµ rÃ ng vá»›i HTTP status codes
- âœ… Conflict detection vá»›i details
- âœ… Há»— trá»£ filter vÃ  pagination
- âœ… API RESTful chuáº©n

---

### 2.4. Routes

#### `schedule.js`
**File:** `ssb-backend/src/routes/api/schedule.js`

```javascript
// GET /api/v1/schedules - Láº¥y danh sÃ¡ch
router.get("/", AuthMiddleware.authenticate, AuthMiddleware.authorize("quan_tri", "tai_xe"), 
  ValidationMiddleware.validatePagination, ScheduleController.getAll);

// POST /api/v1/schedules - Táº¡o má»›i
router.post("/", AuthMiddleware.authenticate, AuthMiddleware.authorize("quan_tri"), 
  ValidationMiddleware.validateSchedule, ScheduleController.create);

// PUT /api/v1/schedules/:id - Cáº­p nháº­t
router.put("/:id", AuthMiddleware.authenticate, AuthMiddleware.authorize("quan_tri"), 
  ValidationMiddleware.validateId, ScheduleController.update);

// DELETE /api/v1/schedules/:id - XÃ³a
router.delete("/:id", AuthMiddleware.authenticate, AuthMiddleware.authorize("quan_tri"), 
  ValidationMiddleware.validateId, ScheduleController.delete);

// GET /api/v1/schedules/date/:date - Láº¥y theo ngÃ y
router.get("/date/:date", AuthMiddleware.authenticate, AuthMiddleware.authorize("quan_tri", "tai_xe"), 
  ScheduleController.getByDate);
```

**ÄÃ¡nh giÃ¡ Routes:**
- âœ… Authentication required
- âœ… Authorization: Chá»‰ `quan_tri` cÃ³ thá»ƒ táº¡o/cáº­p nháº­t/xÃ³a, `tai_xe` cÃ³ thá»ƒ xem
- âœ… Validation middleware
- âœ… RESTful URL structure

---

## ğŸ¨ PHáº¦N 3: FRONTEND

### 3.1. API Client

#### `api.ts`
**File:** `ssb-frontend/lib/api.ts`

**Methods:**

1. **`getSchedules(params)`** - Láº¥y danh sÃ¡ch lá»‹ch trÃ¬nh
   ```typescript
   // Line 464-480
   async getSchedules(params?: {
     maTuyen?: number;
     maXe?: number;
     maTaiXe?: number;
     loaiChuyen?: string;
   }) {
     const queryParams = new URLSearchParams();
     if (params?.maTuyen) queryParams.append("maTuyen", params.maTuyen.toString());
     // ... build query
     return this.request(`/schedules${query ? `?${query}` : ""}`);
   }
   ```

2. **`createSchedule(scheduleData)`** - Táº¡o lá»‹ch trÃ¬nh
   ```typescript
   // Line 486-504
   async createSchedule(scheduleData: any) {
     try {
       return await this.request("/schedules", {
         method: "POST",
         body: JSON.stringify(scheduleData),
       });
     } catch (error: any) {
       // M1-M3: Re-throw with conflict details for 409
       if (error?.status === 409 || error?.response?.status === 409) {
         const conflictData = error?.response?.data || error?.data || {};
         throw {
           ...error,
           conflict: conflictData.details?.conflicts || conflictData.conflicts || [],
           message: conflictData.message || "Xung Ä‘á»™t lá»‹ch trÃ¬nh",
         };
       }
       throw error;
     }
   }
   ```
   - âœ… **Conflict handling:** Re-throw vá»›i conflict details Ä‘á»ƒ component xá»­ lÃ½

3. **`updateSchedule(id, scheduleData)`** - Cáº­p nháº­t lá»‹ch trÃ¬nh
   - TÆ°Æ¡ng tá»± `createSchedule`, cÃ³ conflict handling

4. **`deleteSchedule(id)`** - XÃ³a lá»‹ch trÃ¬nh

**ÄÃ¡nh giÃ¡ API Client:**
- âœ… Error handling vá»›i conflict details
- âœ… TypeScript types
- âœ… Query params building

---

### 3.2. Schedule Form Component

#### `schedule-form.tsx`
**File:** `ssb-frontend/components/admin/schedule-form.tsx`

**Chá»©c nÄƒng:**

1. **Form Fields:**
   - âœ… **NgÃ y cháº¡y:** Calendar picker (date-fns vá»›i locale vi)
   - âœ… **Tuyáº¿n Ä‘Æ°á»ng:** Select dropdown (load tá»« API)
   - âœ… **Xe buÃ½t:** Select dropdown (load tá»« API)
   - âœ… **TÃ i xáº¿:** Select dropdown (load tá»« API)
   - âœ… **Loáº¡i chuyáº¿n:** Select (`don_sang` / `tra_chieu`)
   - âœ… **Giá» khá»Ÿi hÃ nh:** Time input (`type="time"`)

2. **Validation:**
   ```typescript
   // Line 96-103
   if (!date || !route || !bus || !driver || !tripType || !startTime) {
     toast({ title: "Lá»—i", description: "Vui lÃ²ng nháº­p Ä‘áº§y Ä‘á»§ thÃ´ng tin", variant: "destructive" });
     return;
   }
   ```
   - âœ… Client-side validation trÆ°á»›c khi submit

3. **Conflict Error Display:**
   ```typescript
   // Line 182-205
   {conflictError && conflictError.conflicts.length > 0 && (
     <Alert variant="destructive">
       <AlertTitle>Xung Ä‘á»™t lá»‹ch trÃ¬nh</AlertTitle>
       <AlertDescription>
         <ul>
           {conflictError.conflicts.map((conflict, idx) => (
             <li key={idx}>
               {conflict.conflictType === 'bus' && (
                 <>Xe <strong>{conflict.bus}</strong> Ä‘Ã£ cÃ³ lá»‹ch trÃ¬nh vÃ o {conflict.time} ngÃ y {conflict.date}</>
               )}
               {conflict.conflictType === 'driver' && (
                 <>TÃ i xáº¿ <strong>{conflict.driver}</strong> Ä‘Ã£ cÃ³ lá»‹ch trÃ¬nh vÃ o {conflict.time} ngÃ y {conflict.date}</>
               )}
               {/* ... */}
             </li>
           ))}
         </ul>
       </AlertDescription>
     </Alert>
   )}
   ```
   - âœ… **Hiá»ƒn thá»‹ conflict chi tiáº¿t:** Xe hoáº·c tÃ i xáº¿ nÃ o, giá» nÃ o, ngÃ y nÃ o
   - âœ… **User-friendly:** Dá»… hiá»ƒu cho admin

4. **Mode Support:**
   - âœ… `mode="create"` - Táº¡o má»›i
   - âœ… `mode="edit"` - Chá»‰nh sá»­a (pre-fill form vá»›i `initialSchedule`)

**ÄÃ¡nh giÃ¡ Form:**
- âœ… UI/UX tá»‘t vá»›i shadcn/ui components
- âœ… Conflict error display rÃµ rÃ ng
- âœ… Validation Ä‘áº§y Ä‘á»§
- âœ… Há»— trá»£ cáº£ create vÃ  edit mode

---

### 3.3. Schedule Management Page

#### `page.tsx`
**File:** `ssb-frontend/app/admin/schedule/page.tsx`

**Chá»©c nÄƒng:**

1. **View Modes:**
   - âœ… **Table View:** Báº£ng danh sÃ¡ch lá»‹ch trÃ¬nh (desktop)
   - âœ… **Card View:** Card view cho mobile
   - âœ… **Calendar View:** Xem theo lá»‹ch vá»›i calendar picker

2. **Filter & Search:**
   ```typescript
   // Line 295-305
   const filteredSchedules = allSchedules.filter(schedule => {
     const matchesSearch = !searchQuery || 
       schedule.route?.toLowerCase().includes(searchQuery.toLowerCase()) ||
       schedule.bus?.toLowerCase().includes(searchQuery.toLowerCase()) ||
       schedule.driver?.toLowerCase().includes(searchQuery.toLowerCase())
     const matchesTripType = filterTripType === 'all' || schedule.tripType === filterTripType
     const matchesStatus = filterStatus === 'all' || schedule.status === filterStatus
     return matchesSearch && matchesTripType && matchesStatus
   })
   ```
   - âœ… Search: Tuyáº¿n, xe, tÃ i xáº¿
   - âœ… Filter: Loáº¡i chuyáº¿n (`don_sang` / `tra_chieu`), Tráº¡ng thÃ¡i (`active` / `inactive`)

3. **Statistics:**
   ```typescript
   // Line 308-314
   const stats = {
     total: allSchedules.length,
     active: allSchedules.filter(s => s.status === 'active').length,
     morning: allSchedules.filter(s => s.tripType === 'don_sang').length,
     afternoon: allSchedules.filter(s => s.tripType === 'tra_chieu').length,
     today: todaysSchedules.length,
   }
   ```
   - âœ… Hiá»ƒn thá»‹ thá»‘ng kÃª: Tá»•ng, Ä‘ang Ã¡p dá»¥ng, Ä‘Ã³n sÃ¡ng, tráº£ chiá»u, hÃ´m nay

4. **Auto Assign:**
   ```typescript
   // Line 132-246
   async function handleAutoAssign() {
     // Fetch available resources
     const [routesRes, busesRes, driversRes] = await Promise.all([...])
     // Filter active resources
     // Get already assigned for selected date
     // Find available resources
     // Auto-assign: create schedule for first available route, bus, driver
     // ...
   }
   ```
   - âœ… **Tá»± Ä‘á»™ng phÃ¢n cÃ´ng:** Tá»± Ä‘á»™ng táº¡o lá»‹ch trÃ¬nh cho ngÃ y Ä‘Æ°á»£c chá»n
   - âœ… **TrÃ¡nh xung Ä‘á»™t:** Chá»‰ phÃ¢n cÃ´ng xe/tÃ i xáº¿ chÆ°a cÃ³ lá»‹ch trong ngÃ y
   - âœ… **Há»— trá»£ táº¡o lá»‹ch nhanh:** CÃ³ thá»ƒ dÃ¹ng Ä‘á»ƒ táº¡o lá»‹ch cho tuáº§n/thÃ¡ng (láº·p qua tá»«ng ngÃ y)

5. **CRUD Operations:**
   - âœ… **Create:** Dialog vá»›i `ScheduleForm`
   - âœ… **Update:** Dialog vá»›i `ScheduleForm` (edit mode)
   - âœ… **Delete:** Confirm dialog
   - âœ… **Duplicate:** Sao chÃ©p lá»‹ch trÃ¬nh (táº¡o má»›i vá»›i cÃ¹ng thÃ´ng tin)

6. **Calendar View:**
   ```typescript
   // Line 684-807
   <TabsContent value="calendar">
     <Calendar mode="single" selected={date} onSelect={setDate} />
     {/* Today's Schedules */}
     {/* Quick Assignment */}
   </TabsContent>
   ```
   - âœ… Calendar picker Ä‘á»ƒ chá»n ngÃ y
   - âœ… Hiá»ƒn thá»‹ lá»‹ch trÃ¬nh cá»§a ngÃ y Ä‘Æ°á»£c chá»n
   - âœ… Quick assignment cho ngÃ y Ä‘Æ°á»£c chá»n

**ÄÃ¡nh giÃ¡ Page:**
- âœ… UI/UX tá»‘t vá»›i responsive design (mobile/desktop)
- âœ… Äáº§y Ä‘á»§ CRUD operations
- âœ… Filter vÃ  search
- âœ… Calendar view há»— trá»£ táº¡o lá»‹ch theo ngÃ y
- âœ… Auto assign há»— trá»£ táº¡o lá»‹ch nhanh

---

## ğŸ“Š Tá»”NG Káº¾T VÃ€ ÄÃNH GIÃ

### âœ… Äiá»ƒm máº¡nh

1. **Database:**
   - âœ… Schema Ä‘áº§y Ä‘á»§ vá»›i UNIQUE constraint trÃ¡nh xung Ä‘á»™t
   - âœ… Indexes tá»‘i Æ°u cho query performance
   - âœ… Soft delete vá»›i `dangApDung`
   - âœ… Foreign keys Ä‘áº£m báº£o tÃ­nh toÃ n váº¹n

2. **Backend:**
   - âœ… API RESTful chuáº©n
   - âœ… Conflict detection chi tiáº¿t vá»›i error details
   - âœ… Validation Ä‘áº§y Ä‘á»§ á»Ÿ nhiá»u layers
   - âœ… Error handling rÃµ rÃ ng vá»›i HTTP status codes
   - âœ… Service layer tÃ¡ch biá»‡t business logic

3. **Frontend:**
   - âœ… UI/UX tá»‘t vá»›i responsive design
   - âœ… Conflict error display user-friendly
   - âœ… Calendar view há»— trá»£ táº¡o lá»‹ch theo ngÃ y
   - âœ… Auto assign há»— trá»£ táº¡o lá»‹ch nhanh

### âš ï¸ Äiá»ƒm cáº§n cáº£i thiá»‡n

1. **Batch Create cho Tuáº§n/ThÃ¡ng:**
   - âš ï¸ Hiá»‡n táº¡i chá»‰ há»— trá»£ táº¡o lá»‹ch trÃ¬nh theo tá»«ng ngÃ y
   - ğŸ’¡ **Äá» xuáº¥t:** ThÃªm API `POST /api/v1/schedules/batch` Ä‘á»ƒ táº¡o nhiá»u lá»‹ch trÃ¬nh cÃ¹ng lÃºc
   ```javascript
   // VÃ­ dá»¥:
   POST /api/v1/schedules/batch
   {
     "startDate": "2025-11-12",
     "endDate": "2025-11-18", // hoáº·c "2025-12-12" cho thÃ¡ng
     "daysOfWeek": [1, 2, 3, 4, 5], // Thá»© 2-6
     "maTuyen": 1,
     "maXe": 1,
     "maTaiXe": 2,
     "loaiChuyen": "don_sang",
     "gioKhoiHanh": "06:30"
   }
   ```

2. **Recurring Schedules:**
   - âš ï¸ ChÆ°a há»— trá»£ lá»‹ch trÃ¬nh láº·p láº¡i (recurring)
   - ğŸ’¡ **Äá» xuáº¥t:** ThÃªm trÆ°á»ng `recurringType` (`daily`, `weekly`, `monthly`) vÃ  `recurringEndDate`

3. **Bulk Update:**
   - âš ï¸ ChÆ°a há»— trá»£ cáº­p nháº­t nhiá»u lá»‹ch trÃ¬nh cÃ¹ng lÃºc
   - ğŸ’¡ **Äá» xuáº¥t:** ThÃªm API `PUT /api/v1/schedules/bulk` vá»›i filter vÃ  update data

### âœ… Káº¿t luáº­n

**Tráº¡ng thÃ¡i:** âœ… **HOÃ€N THÃ€NH Äáº¦Y Äá»¦** (vá»›i lÆ°u Ã½ vá» batch create)

Há»‡ thá»‘ng Ä‘Ã£ triá»ƒn khai Ä‘áº§y Ä‘á»§ chá»©c nÄƒng **"Táº¡o vÃ  cáº­p nháº­t lá»‹ch trÃ¬nh xe"** vá»›i:
- âœ… Database schema Ä‘áº§y Ä‘á»§ vá»›i conflict prevention
- âœ… Backend API RESTful vá»›i conflict detection chi tiáº¿t
- âœ… Frontend UI Ä‘áº§y Ä‘á»§ vá»›i form, calendar view, auto assign
- âœ… Há»— trá»£ táº¡o lá»‹ch theo ngÃ y (cÃ³ thá»ƒ má»Ÿ rá»™ng batch create cho tuáº§n/thÃ¡ng)

**YÃªu cáº§u Ä‘Ã¡p á»©ng:**
- âœ… Táº¡o lá»‹ch trÃ¬nh má»›i
- âœ… Cáº­p nháº­t lá»‹ch trÃ¬nh
- âœ… XÃ³a lá»‹ch trÃ¬nh
- âœ… Kiá»ƒm tra xung Ä‘á»™t
- âœ… Há»— trá»£ táº¡o lá»‹ch theo ngÃ y (cÃ³ thá»ƒ dÃ¹ng Ä‘á»ƒ táº¡o cho tuáº§n/thÃ¡ng báº±ng cÃ¡ch láº·p qua tá»«ng ngÃ y)

**Khuyáº¿n nghá»‹:**
- ğŸ’¡ ThÃªm batch create API Ä‘á»ƒ táº¡o lá»‹ch cho tuáº§n/thÃ¡ng dá»… dÃ ng hÆ¡n
- ğŸ’¡ ThÃªm recurring schedules cho lá»‹ch trÃ¬nh láº·p láº¡i

---

**NgÆ°á»i kiá»ƒm tra:** AI Assistant  
**NgÃ y hoÃ n thÃ nh:** 2025-11-12

