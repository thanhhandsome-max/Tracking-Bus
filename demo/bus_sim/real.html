<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chế độ Real - Gửi Tọa Độ Thật</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        #status { font-weight: bold; }
        pre { background-color: #f4f4f4; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>Chế độ Real - Gửi Tọa Độ Thật (QA)</h1>
    <p>Trang này sẽ lấy tọa độ GPS thật từ thiết bị của bạn và gửi đến server.</p>
    
    <label for="tripId">Nhập Trip ID (Chuyến đi):</label>
    <input type="text" id="tripId" value="32"> <label for="busId">Nhập Bus ID (Xe):</label>
    <input type="text" id="busId" value="1"> <button id="startButton">Bắt đầu Gửi Tọa Độ</button>
    <button id="stopButton" disabled>Dừng Gửi</button>

    <hr>
    <h3>Trạng thái: <span id="status" style="color: red;">Chưa kết nối</span></h3>
    <h3>Dữ liệu cuối cùng được gửi:</h3>
    <pre id="payload">Chưa có dữ liệu...</pre>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

    <script>
        // --- CẤU HÌNH ---
        const WS_URL = "http://localhost:4000"; // Địa chỉ server
        const DRIVER_TOKEN = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjIsImVtYWlsIjoidGFpeGUxQHNjaG9vbGJ1cy52biIsInZhaVRybyI6InRhaV94ZSIsImlhdCI6MTc2MzEzMDc1OCwiZXhwIjoxNzYzMTMyNTU4fQ.EDl_aSQ-D8s3f66diDACm8IvaEoaSrmb-UzKj6YVpQU"; // Lấy token mới nhất
        // --- KẾT THÚC CẤU HÌNH ---

        const statusEl = document.getElementById('status');
        const payloadEl = document.getElementById('payload');
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const tripIdInput = document.getElementById('tripId');
        const busIdInput = document.getElementById('busId');

        let socket;
        let watchId = null;

        startButton.onclick = function() {
            if (!DRIVER_TOKEN.startsWith("ey")) {
                alert("Lỗi: Bạn chưa dán DRIVER_TOKEN vào file real.html!");
                return;
            }

            // 1. Kết nối Socket.IO
            socket = io(WS_URL, {
                auth: { token: DRIVER_TOKEN }
            });

            socket.on("connect", () => {
                statusEl.textContent = "Đã kết nối";
                statusEl.style.color = "green";
                startButton.disabled = true;
                stopButton.disabled = false;

                const tripId = tripIdInput.value;
                const roomName = `trip-${tripId}`;
                socket.emit("join_room", roomName);
                console.log(`Đã tham gia room: ${roomName}`);

                // 2. Bắt đầu theo dõi vị trí GPS
                startWatching();
            });

            socket.on("connect_error", (err) => {
                statusEl.textContent = `Lỗi kết nối: ${err.message}`;
                statusEl.style.color = "red";
            });

            socket.on("disconnect", () => {
                statusEl.textContent = "Đã ngắt kết nối";
                statusEl.style.color = "red";
                stopWatching();
            });
        };

        stopButton.onclick = function() {
            stopWatching();
            if (socket) socket.disconnect();
            startButton.disabled = false;
            stopButton.disabled = true;
            statusEl.textContent = "Đã dừng";
            statusEl.style.color = "orange";
        };

        function startWatching() {
            if (!("geolocation" in navigator)) {
                statusEl.textContent = "Lỗi: Trình duyệt không hỗ trợ Geolocation";
                return;
            }

            // Bắt đầu theo dõi vị trí
            watchId = navigator.geolocation.watchPosition(
                (position) => {
                    const { latitude, longitude, speed, heading } = position.coords;
                    const tripId = tripIdInput.value;
                    const busId = busIdInput.value;

                    const payload = {
                        tripId: parseInt(tripId),
                        busId: parseInt(busId),
                        lat: parseFloat(latitude.toFixed(6)),
                        lng: parseFloat(longitude.toFixed(6)),
                        speed: speed ? speed * 3.6 : 0, // m/s -> km/h
                        heading: heading || 0,
                        ts: Date.now()
                    };

                    // 3. Gửi sự kiện bus_position_update
                    if (socket && socket.connected) {
                        socket.emit("bus_position_update", payload);
                        
                        // Cập nhật giao diện
                        payloadEl.textContent = JSON.stringify(payload, null, 2);
                        statusEl.textContent = "Đang gửi tọa độ...";
                    }
                },
                (error) => {
                    statusEl.textContent = `Lỗi GPS: ${error.message}`;
                    statusEl.style.color = "red";
                },
                {
                    enableHighAccuracy: true, // Yêu cầu GPS chính xác cao
                    maximumAge: 0 // Không dùng cache
                }
            );
        }

        function stopWatching() {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
        }

    </script>
</body>
</html>